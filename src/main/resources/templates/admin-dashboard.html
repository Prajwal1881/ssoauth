<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard</title>
    <style>
        :root {
            --primary-orange: #FF6600;
            --secondary-orange: #FF9933;
            --background-color: #F8F8F8;
            --form-background: #FFFFFF;
            --text-color: #333333;
            --border-color: #DDDDDD;
            --error-color: #DC3545;
            --success-color: #28a745;
            --link-color: #007bff;
            --tab-inactive-bg: #E9ECEF;
            --tab-active-bg: var(--form-background);
            --tab-active-border: var(--primary-orange);
            --input-focus-border: var(--primary-orange);
            --input-focus-shadow: rgba(255, 102, 0, 0.2);
            --toggle-bg-off: #ccc;
            --toggle-bg-on: var(--primary-orange);
            --toggle-knob: white;
        }

        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 0; margin: 0; background-color: var(--background-color); color: var(--text-color); }
        h1, h2, h3 { color: var(--primary-orange); font-weight: 600; margin-bottom: 10px; }
        h4 { color: var(--text-color); font-weight: 600; margin-top: 25px; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; }

        .admin-container { padding: 20px 30px; }
        .admin-header { display: flex; justify-content: space-between; align-items: center; background-color: #fff; padding: 10px 30px; border-bottom: 2px solid var(--primary-orange); box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .admin-header h1 { font-size: 1.5em; margin: 0; }
        .admin-nav a, .admin-nav button { margin-left: 15px; text-decoration: none; padding: 8px 15px; border-radius: 4px; font-size: 0.9em; }
        .admin-nav .button-link { background-color: #6c757d; color: white; border: none; }
        .admin-nav .btn-logout { background-color: var(--link-color); color: white; border: none; cursor: pointer; }
        .tab-nav { border-bottom: 1px solid var(--border-color); padding-left: 0; margin-bottom: 20px; list-style: none; display: flex; flex-wrap: wrap; }
        .tab-nav li { margin-right: 5px; margin-bottom: -1px; }
        .tab-nav button { background-color: var(--tab-inactive-bg); border: 1px solid var(--border-color); border-bottom: none; padding: 10px 15px; cursor: pointer; border-radius: 6px 6px 0 0; font-size: 0.95em; font-weight: 500; color: var(--text-color); transition: background-color 0.2s; }
        .tab-nav button:hover { background-color: #ddd; }
        .tab-nav button.active { background-color: var(--tab-active-bg); border-color: var(--border-color); border-bottom: 1px solid var(--tab-active-bg); position: relative; top: 1px; color: var(--primary-orange); font-weight: 600; }
        .tab-nav button.active::after { content: ''; position: absolute; bottom: -1px; left: 0; right: 0; height: 3px; background-color: var(--tab-active-border); }
        .tab-content { display: none; padding: 20px; background-color: var(--form-background); border: 1px solid var(--border-color); border-radius: 0 8px 8px 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .tab-content.active { display: block; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 20px; background-color: var(--form-background); border-radius: 8px; overflow: hidden; }
        th, td { border: 1px solid var(--border-color); padding: 12px; text-align: left; font-size: 0.9em; }
        th { background-color: #EFEFEF; font-weight: 600; border-bottom: 2px solid var(--primary-orange); }
        tr:nth-child(even) { background-color: #F8F8F8; }
        button, .button-link { margin: 5px 2px; padding: 8px 15px; border-radius: 4px; border: none; font-size: 0.9em; cursor: pointer; }
        .btn-create { background-color: #28a745; color: white; }
        .btn-edit { background-color: var(--secondary-orange); color: var(--text-color); }
        .btn-delete { background-color: var(--error-color); color: white; }
        .btn-save { background-color: var(--primary-orange); color: white; margin-top: 10px; }
        /* This is now the one and only test button */
        .btn-test { background-color: var(--success-color); color: white; margin-top: 10px; margin-left: 10px;}

        .sso-form { margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px dashed var(--border-color); }
        .sso-form:last-child { border-bottom: none; }
        label { display: block; margin-bottom: 8px; font-weight: 500; font-size: 0.95em; }
        input[type=text], input[type=email], input[type=password], input[type=url], textarea, select { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 1em; box-sizing: border-box; background-color: #fff; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: var(--input-focus-border); box-shadow: 0 0 0 2px var(--input-focus-shadow); }
        textarea { min-height: 80px; resize: vertical; font-family: inherit; }
        .form-row { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 0; }
        .form-row > div { flex: 1; min-width: 200px; }
        .toggle-switch { display: flex; align-items: center; margin-bottom: 15px; }
        .toggle-switch label { margin-right: 10px; margin-bottom: 0; }
        .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--toggle-bg-off); transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: var(--toggle-knob); transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--toggle-bg-on); }
        input:checked + .slider:before { transform: translateX(26px); }
        .error { color: var(--error-color); background-color: #f8d7da; padding: 10px; border-radius: 4px; margin-bottom: 15px; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: var(--form-background); margin: 10% auto; padding: 25px; border: 1px solid #888; width: 90%; max-width: 550px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .close { color: #aaa; float: right; font-size: 30px; font-weight: bold; cursor: pointer; line-height: 1; }

        /* Removed static test modal styles */

        .password-wrapper { position: relative; display: flex; align-items: center; width: 100%; margin-bottom: 15px; }
        .password-wrapper input { padding-right: 65px; margin-bottom: 0; }
        .toggle-password { position: absolute; right: 1px; top: 1px; bottom: 1px; border: none; background: #f0f0f0; color: var(--text-color); padding: 0 10px; cursor: pointer; font-size: 0.8em; font-weight: 600; border-radius: 0 4px 4px 0; z-index: 2; width: 60px; }
        .toggle-password:hover { background: #e0e0e0; }
    </style>
</head>
<body>

<div class="admin-header">
    <h1>Admin Panel</h1>
    <div class="admin-nav">
        <a href="/dashboard" class="button-link">Go to User Dashboard</a>
        <button id="logout-button" class="btn-logout">Logout</button>
    </div>
</div>

<div class="admin-container">
    <ul class="tab-nav">
        <li><button class="tab-button active" onclick="openTab(event, 'welcome')">Welcome</button></li>
        <li><button class="tab-button" onclick="openTab(event, 'userManagement')">User Management</button></li>
        <li><button class="tab-button" onclick="openTab(event, 'samlConfig')">SAML Config</button></li>
        <li><button class="tab-button" onclick="openTab(event, 'oidcConfig')">OIDC Config</button></li>
        <li><button class="tab-button" onclick="openTab(event, 'jwtConfig')">JWT Config</button></li>
    </ul>

    <div id="welcome" class="tab-content active">
        <h2>Welcome, Admin!</h2>
        <p>Use the tabs above to manage users or configure Single Sign-On providers.</p>
        <h4>How to Test Your SSO Configuration:</h4>
        <ol>
            <li>Configure and save an SSO provider (e.g., OIDC, SAML, or JWT).</li>
            <li>Click the **"Test Connection"** button. This will open a new popup window.</li>
            <li>Perform a real SSO login as a test user *in that popup window*.</li>
            <li>The popup window will refresh and show you a "TEST SUCCESSFUL" message along with a table of all attributes your app received from the IdP.</li>
            <li>You can also check your application's console logs for a message starting with "--- ATTRIBUTE DUMP (START) ---".</li>
            </I>
    </div>

    <div id="userManagement" class="tab-content">
        <h2>User Management</h2>
        <button onclick="openCreateModal()" class="btn-create">Create New User</button>
        <div id="error-message" class="error" style="display: none;"></div>
        <table id="user-table">
            <thead><tr><th>ID</th><th>Username</th><th>Email</th><th>First Name</th><th>Last Name</th><th>Roles</th><th>Provider</th><th>Actions</th></tr></thead>
            <tbody><tr><td colspan="8">Loading users...</td></tr></tbody>
        </table>
    </div>


    <div id="samlConfig" class="tab-content">
        <h2>SAML Configuration</h2>
        <div id="saml-error-message" class="error" style="display: none;"></div>
        <form id="samlConfigForm" class="sso-form" data-provider-type="SAML" data-provider-id="saml_miniorange">
            <h4>General Settings</h4>
            <div class="toggle-switch">
                <label for="samlEnable">Enable SAML Provider:</label>
                <label class="switch"><input type="checkbox" id="samlEnable"><span class="slider"></span></label>
            </div>
            <label for="samlDisplayName">Display Name:</label>
            <input type="text" id="samlDisplayName" placeholder="e.g., Okta SAML">

            <h4>Identity Provider (IdP) Details</h4>
            <label for="samlEntityId">Identity Provider Entity ID:</label>
            <input type="text" id="samlEntityId" placeholder="e.g., https://idp.example.com/entityid">
            <label for="samlSsoUrl">SSO URL (Login Endpoint):</label>
            <input type="url" id="samlSsoUrl" placeholder="e.g., https://idp.example.com/sso">
            <label for="samlCertificate">X.509 Certificate (PEM format):</label>
            <textarea id="samlCertificate" placeholder="Paste the certificate here..."></textarea>

            <button type="submit" class="btn-save">Save SAML Config</button>
            <button type="button" class="btn-test" onclick="testAttributes('saml_miniorange')">
                Test Connection
            </button>
        </form>
    </div>

    <div id="oidcConfig" class="tab-content">
        <h2>OAuth 2.0 / OpenID Connect Configuration</h2>
        <div id="oidc-error-message" class="error" style="display: none;"></div>
        <form id="oidcConfigForm" class="sso-form" data-provider-type="OIDC" data-provider-id="oidc_miniorange">
            <h4>General Settings</h4>
            <div class="toggle-switch">
                <label for="oidcEnable">Enable OIDC Provider:</label>
                <label class="switch"><input type="checkbox" id="oidcEnable"><span class="slider"></span></label>
            </div>
            <label for="oidcDisplayName">Display Name:</label>
            <input type="text" id="oidcDisplayName" placeholder="e.g., MiniOrange OIDC">

            <h4>Identity Provider (IdP) Details</h4>
            <label for="oidcIssuerUri">Issuer URI: (Leave blank to use discovery)</label>
            <input type="url" id="oidcIssuerUri" placeholder="e.g., httpss://csumairkhan.xecurify.com/moas/discovery/v2.0/...">
            <div class="form-row">
                <div><label for="oidcClientId">Client ID:</label><input type="text" id="oidcClientId"></div>
                <div>
                    <label for="oidcClientSecret">Client Secret:</label>
                    <div class="password-wrapper">
                        <input type="password" id="oidcClientSecret" placeholder="Enter new secret to update">
                        <button type="button" class="toggle-password" id="toggleOidcSecret">Show</button>
                    </div>
                </div>
            </div>
            <label for="oidcScopes">Scopes (comma-separated):</label>
            <input type="text" id="oidcScopes" value="openid, profile, email">
            <label for="oidcUserNameAttribute">User Name Attribute (claim):</label>
            <input type="text" id="oidcUserNameAttribute" value="email" placeholder="e.g., email or sub">

            <h4>Endpoint Overrides (Optional)</h4>
            <label for="oidcAuthorizationUri">Authorization Endpoint URI:</label>
            <input type="url" id="oidcAuthorizationUri">
            <label for="oidcTokenUri">Token Endpoint URI:</label>
            <input type="url" id="oidcTokenUri">
            <label for="oidcUserInfoUri">UserInfo Endpoint URI:</label>
            <input type="url" id="oidcUserInfoUri">
            <label for="oidcJwkSetUri">JWK Set URI:</label>
            <input type="url" id="oidcJwkSetUri">

            <button type="submit" class="btn-save">Save OIDC Config</button>
            <button type="button" class="btn-test" onclick="testAttributes('oidc_miniorange')">
                Test Connection
            </button>
        </form>
    </div>

    <div id="jwtConfig" class="tab-content">
        <h2>Manual JWT Configuration</h2>
        <div id="jwt-error-message" class="error" style="display: none;"></div>
        <form id="jwtConfigForm" class="sso-form" data-provider-type="JWT" data-provider-id="jwt_miniorange">
            <h4>General Settings</h4>
            <div class="toggle-switch">
                <label for="jwtEnable">Enable JWT Provider:</label>
                <label class="switch"><input type="checkbox" id="jwtEnable"><span class="slider"></span></label>
            </div>
            <label for="jwtDisplayName">Display Name:</label>
            <input type="text" id="jwtDisplayName" placeholder="e.g., MiniOrange JWT">

            <h4>Identity Provider (IdP) Details</h4>
            <label for="jwtSsoUrl">JWT SSO URL:</label>
            <input type="url" id="jwtSsoUrl" placeholder="e.g., https://idp.example.com/jwtsso/appid">
            <div class="form-row">
                <div><label for="jwtClientId">Client ID:</label><input type="text" id="jwtClientId"></div>
                <div>
                    <label for="jwtClientSecret">Client Secret (if applicable):</label>
                    <div class="password-wrapper">
                        <input type="password" id="jwtClientSecret" placeholder="Secret if needed by IdP">
                        <button type="button" class="toggle-password" id="toggleJwtSecret">Show</button>
                    </div>
                </div>
            </div>
            <label for="jwtRedirectUri">Redirect URI (Callback URL):</label>
            <input type="url" id="jwtRedirectUri" placeholder="e.g., http://localhost:8080/login/jwt/callback">
            <label for="jwtIssuerUri">Expected Issuer (iss claim):</label>
            <input type="text" id="jwtIssuerUri" placeholder="e.g., Your Client ID or Issuer URL">
            <label for="jwtCertificate">Certificate Content (PEM format):</label>
            <textarea id="jwtCertificate" placeholder="Paste PEM certificate here..."></textarea>

            <button type="submit" class="btn-save">Save JWT Config</button>
            <button type="button" class="btn-test" onclick="testAttributes('jwt_miniorange')">
                Test Connection
            </button>
        </form>
    </div>
</div>

<div id="userModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2 id="modalTitle">User Form</h2>
        <div id="modal-error" class="error" style="display: none;"></div>
        <form id="userForm">
            <input type="hidden" id="userId">
            <div><label for="username">Username:</label><input type="text" id="username" required></div>
            <div><label for="email">Email:</label><input type="email" id="email" required></div>
            <div><label for="password">Password:</label><input type="password" id="password" placeholder="Leave blank if no change"></div>
            <div><label for="firstName">First Name:</label><input type="text" id="firstName"></div>
            <div><label for="lastName">Last Name:</label><input type="text" id="lastName"></div>
            <div><label for="roles">Roles:</label><input type="text" id="roles"></div>
            <button type="submit" class="btn-save">Save User</button>
        </form>
    </div>
</div>


<script>
    // --- User Management Variables ---
    const userTableBody = document.getElementById('user-table').getElementsByTagName('tbody')[0];
    const errorMessageDiv = document.getElementById('error-message');
    const token = localStorage.getItem('accessToken');
    const modal = document.getElementById('userModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalError = document.getElementById('modal-error');
    const userForm = document.getElementById('userForm');
    const userIdInput = document.getElementById('userId');
    const usernameInput = document.getElementById('username');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const firstNameInput = document.getElementById('firstName');
    const lastNameInput = document.getElementById('lastName');
    const rolesInput = document.getElementById('roles');

    // --- SSO Config Variables ---
    const samlErrorDiv = document.getElementById('saml-error-message');
    const oidcErrorDiv = document.getElementById('oidc-error-message');
    const jwtErrorDiv = document.getElementById('jwt-error-message');
    const samlConfigForm = document.getElementById('samlConfigForm');
    const oidcConfigForm = document.getElementById('oidcConfigForm');
    const jwtConfigForm = document.getElementById('jwtConfigForm');
    let configDataStore = {};

    // --- REMOVED Test Connection Modal Variables ---


    // --- Tab switching logic ---
    function openTab(evt, tabName) {
        const tabcontent = document.getElementsByClassName("tab-content");
        for (let i = 0; i < tabcontent.length; i++) tabcontent[i].style.display = "none";
        const tablinks = document.getElementsByClassName("tab-button");
        for (let i = 0; i < tablinks.length; i++) tablinks[i].className = tablinks[i].className.replace(" active", "");
        const currentTab = document.getElementById(tabName);
        if (currentTab) currentTab.style.display = "block";
        if (evt && evt.currentTarget) evt.currentTarget.className += " active";

        if (tabName === 'userManagement') loadUsers();
        else if (tabName === 'samlConfig' || tabName === 'oidcConfig' || tabName === 'jwtConfig') {
            loadSsoConfigurations();
        }
    }

    // --- User Management Functions ---
     async function loadUsers() {
         clearErrors();
        if (!token) { showError("Token not found."); userTableBody.innerHTML = '<tr><td colspan="8">Auth failed.</td></tr>'; return; }
        userTableBody.innerHTML = '<tr><td colspan="8">Loading...</td></tr>';
        try {
            const response = await fetch('/api/admin/users', { headers: { 'Authorization': 'Bearer ' + token } });
            if (!response.ok) { handleApiError(response, "load users", false, errorMessageDiv); return; }
            const users = await response.json();
            renderTable(users);
        } catch (error) { console.error('Load users error:', error); showError(`Failed to load: ${error.message}`); }
    }
    function renderTable(users) {
        userTableBody.innerHTML = '';
        if (!users || users.length === 0) { userTableBody.innerHTML = '<tr><td colspan="8">No users found.</td></tr>'; return; }
        users.forEach(user => {
            const row = userTableBody.insertRow();
            row.insertCell().textContent = user.id; row.insertCell().textContent = user.username; row.insertCell().textContent = user.email;
            row.insertCell().textContent = user.firstName || 'N/A'; row.insertCell().textContent = user.lastName || 'N/A';
            row.insertCell().textContent = user.roles || 'N/A'; row.insertCell().textContent = user.authProvider;
            row.insertCell().innerHTML = `<button onclick="openEditModal(${user.id})" class="btn-edit">Edit</button> <button onclick="deleteUser(${user.id}, '${user.username}')" class="btn-delete">Delete</button>`;
        });
     }
    function openCreateModal() {
        modalTitle.textContent = "Create User"; userForm.reset(); userIdInput.value = '';
        passwordInput.required = true; passwordInput.placeholder = "Required"; rolesInput.value = 'ROLE_USER';
        clearModalError(); modal.style.display = "block";
    }
    async function openEditModal(userId) {
        clearErrors(); clearModalError(); userForm.reset();
        try {
            const response = await fetch(`/api/admin/users/${userId}`, { headers: { 'Authorization': 'Bearer ' + token } });
            if (!response.ok) { handleApiError(response, `fetch user ${userId}`, false, errorMessageDiv); return; }
            const user = await response.json();
            modalTitle.textContent = `Edit User (ID: ${user.id})`;
            userIdInput.value = user.id; usernameInput.value = user.username; emailInput.value = user.email;
            firstNameInput.value = user.firstName || ''; lastNameInput.value = user.lastName || ''; rolesInput.value = user.roles || '';
            passwordInput.required = false; passwordInput.placeholder = "Leave blank for no change";
            modal.style.display = "block";
        } catch(error) { console.error("Edit error:", error); showError(`Load failed: ${error.message}`); }
     }
    function closeModal() { modal.style.display = "none"; }
    window.onclick = function(event) {
        if (event.target == modal) closeModal();
        // if (event.target == testModal) closeTestConnectionModal(); // REMOVED
    }
    userForm.addEventListener('submit', async (event) => {
         event.preventDefault(); clearErrors(); clearModalError();
        const userId = userIdInput.value; const isUpdate = !!userId;
        const url = isUpdate ? `/api/admin/users/${userId}` : '/api/admin/users'; const method = isUpdate ? 'PUT' : 'POST';
        const userData = { username: usernameInput.value, email: emailInput.value, firstName: firstNameInput.value, lastName: lastNameInput.value, roles: rolesInput.value, password: passwordInput.value };
        if (isUpdate && (!userData.password || userData.password.trim() === '')) delete userData.password;
        if (!isUpdate && (!userData.password || userData.password.trim() === '')) { showModalError("Password required."); return; }
        try {
             const response = await fetch(url, { method: method, headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token }, body: JSON.stringify(userData) });
            if (!response.ok) { await handleApiError(response, isUpdate ? "update user" : "create user", true, modalError); return; }
            closeModal(); loadUsers();
        } catch (error) { console.error("Save error:", error); showModalError(`Error: ${error.message}`); }
     });
    async function deleteUser(id, username) {
         clearErrors(); if (!confirm(`Delete '${username}' (ID: ${id})?`)) return;
        try {
            const response = await fetch(`/api/admin/users/${id}`, { method: 'DELETE', headers: { 'Authorization': 'Bearer ' + token } });
            if (!response.ok) { handleApiError(response, `delete user ${id}`, false, errorMessageDiv); return; }
            loadUsers();
        } catch (error) { console.error('Delete error:', error); showError(`Delete failed: ${error.message}`); }
     }


    // --- Load SSO Configurations ---
    async function loadSsoConfigurations() {
        clearSsoErrors('all');
        if (!token) { showSsoError("Token not found.", 'all'); return; }
        console.log("Loading SSO configs...");
        try {
            const response = await fetch('/api/admin/sso-config', { headers: { 'Authorization': 'Bearer ' + token } });
            if (!response.ok) { handleApiError(response, "load SSO configs", false, getErrorDivForType('all')); return; }
            const configs = await response.json();
            console.log("Received SSO configs:", configs);
            populateSsoForms(configs);
        } catch (error) { console.error('Load SSO config error:', error); showSsoError(`Load failed: ${error.message}`, 'all'); }
    }

    // --- Populate SSO Forms ---
    function populateSsoForms(configs) {
        configDataStore = {};
        samlConfigForm.reset();
        oidcConfigForm.reset();
        jwtConfigForm.reset();

        document.getElementById('oidcClientSecret').placeholder = 'Enter new secret to update';
        document.getElementById('jwtClientSecret').placeholder = 'Enter new secret to update (if used)';
        document.getElementById('oidcClientSecret').setAttribute('type', 'password');
        document.getElementById('toggleOidcSecret').textContent = 'Show';
        document.getElementById('jwtClientSecret').setAttribute('type', 'password');
        document.getElementById('toggleJwtSecret').textContent = 'Show';

        configs.forEach(config => {
            if (!config.providerId || !config.id) {
                console.error("Config object missing providerId or id:", config);
                return;
            }
            configDataStore[config.providerId] = config.id;

            try {
                if (config.providerType === 'SAML' && config.providerId === samlConfigForm.dataset.providerId) {
                    document.getElementById('samlEnable').checked = config.enabled;
                    document.getElementById('samlDisplayName').value = config.displayName || '';
                    document.getElementById('samlEntityId').value = config.samlEntityId || '';
                    document.getElementById('samlSsoUrl').value = config.samlSsoUrl || '';
                    document.getElementById('samlCertificate').value = config.samlCertificate || '';
                } else if (config.providerType === 'OIDC' && config.providerId === oidcConfigForm.dataset.providerId) {
                     document.getElementById('oidcEnable').checked = config.enabled;
                     document.getElementById('oidcDisplayName').value = config.displayName || '';
                     document.getElementById('oidcIssuerUri').value = config.issuerUri || '';
                     document.getElementById('oidcClientId').value = config.clientId || '';
                     // Do NOT populate the secret field, it's write-only
                     // document.getElementById('oidcClientSecret').value = config.clientSecret || '';
                     document.getElementById('oidcScopes').value = config.scopes || 'openid, profile, email';
                     document.getElementById('oidcAuthorizationUri').value = config.authorizationUri || '';
                     document.getElementById('oidcTokenUri').value = config.tokenUri || '';
                     document.getElementById('oidcUserInfoUri').value = config.userInfoUri || '';
                     document.getElementById('oidcJwkSetUri').value = config.jwkSetUri || '';
                     document.getElementById('oidcUserNameAttribute').value = config.userNameAttribute || 'email';
                } else if (config.providerType === 'JWT' && config.providerId === jwtConfigForm.dataset.providerId) {
                     document.getElementById('jwtEnable').checked = config.enabled;
                     document.getElementById('jwtDisplayName').value = config.displayName || '';
                     document.getElementById('jwtSsoUrl').value = config.jwtSsoUrl || '';
                     document.getElementById('jwtClientId').value = config.clientId || '';
                     // Do NOT populate the secret field, it's write-only
                     // document.getElementById('jwtClientSecret').value = config.clientSecret || '';
                     document.getElementById('jwtRedirectUri').value = config.jwtRedirectUri || 'http://localhost:8080/login/jwt/callback';
                     document.getElementById('jwtIssuerUri').value = config.issuerUri || '';
                     document.getElementById('jwtCertificate').value = config.jwtCertificate || '';
                }
            } catch (e) {
                console.error(`Error populating form for provider ${config.providerId}:`, e);
                showSsoError(`Error populating form: ${e.message}`, config.providerType);
            }
        });
        console.log("Populated forms. Store:", configDataStore);
    }

    // --- Save SSO Config Logic ---
    async function saveSsoConfig(formElement, providerType) {
        clearSsoErrors(providerType);
        if (!token) { showSsoError("Token not found.", providerType); return; }

        const providerId = formElement.dataset.providerId;
        if (!providerId) {
            showSsoError("Form is missing 'data-provider-id' attribute.", providerType);
            return;
        }

        const configId = configDataStore[providerId];
        // *** FIX: Check if config exists in store. If not, it's a CREATE. ***
        const isUpdate = !!configId;
        const url = isUpdate ? `/api/admin/sso-config/${configId}` : '/api/admin/sso-config';
        const method = isUpdate ? 'PUT' : 'POST';

        let configData = { providerId: providerId, providerType: providerType };

        if (providerType === 'SAML') {
            configData.enabled = document.getElementById('samlEnable').checked;
            configData.displayName = document.getElementById('samlDisplayName').value;
            configData.samlEntityId = document.getElementById('samlEntityId').value;
            configData.samlSsoUrl = document.getElementById('samlSsoUrl').value;
            configData.samlCertificate = document.getElementById('samlCertificate').value;
            configData.issuerUri = configData.samlEntityId; // Set common field
        } else if (providerType === 'OIDC') {
             configData.enabled = document.getElementById('oidcEnable').checked;
             configData.displayName = document.getElementById('oidcDisplayName').value;
             configData.issuerUri = document.getElementById('oidcIssuerUri').value;
             configData.clientId = document.getElementById('oidcClientId').value;
             const secret = document.getElementById('oidcClientSecret').value;
             if (secret && secret.trim() !== '') configData.clientSecret = secret;
             configData.scopes = document.getElementById('oidcScopes').value;
             configData.authorizationUri = document.getElementById('oidcAuthorizationUri').value;
             configData.tokenUri = document.getElementById('oidcTokenUri').value;
             configData.userInfoUri = document.getElementById('oidcUserInfoUri').value;
             configData.jwkSetUri = document.getElementById('oidcJwkSetUri').value;
             configData.userNameAttribute = document.getElementById('oidcUserNameAttribute').value;
        } else if (providerType === 'JWT') {
            configData.enabled = document.getElementById('jwtEnable').checked;
            configData.displayName = document.getElementById('jwtDisplayName').value;
            configData.jwtSsoUrl = document.getElementById('jwtSsoUrl').value;
            configData.clientId = document.getElementById('jwtClientId').value;
            const secret = document.getElementById('jwtClientSecret').value;
             if (secret && secret.trim() !== '') configData.clientSecret = secret;
            configData.jwtRedirectUri = document.getElementById('jwtRedirectUri').value;
            configData.issuerUri = document.getElementById('jwtIssuerUri').value; // Use common field
            configData.jwtCertificate = document.getElementById('jwtCertificate').value;
        }

        console.log(`Saving SSO Config - ${method}. Data:`, configData);

        try {
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                body: JSON.stringify(configData)
            });
            if (!response.ok) { await handleApiError(response, `save ${providerType} config`, false, getErrorDivForType(providerType)); return; }

            alert(`${providerType} configuration saved successfully!`);
            loadSsoConfigurations(); // Reload data

        } catch (error) { console.error(`Error saving ${providerType} config:`, error); showSsoError(`Failed to save: ${error.message}`, providerType); }
    }

    // --- Attach Save Logic ---
    samlConfigForm.addEventListener('submit', (e) => { e.preventDefault(); saveSsoConfig(e.target, 'SAML'); });
    oidcConfigForm.addEventListener('submit', (e) => { e.preventDefault(); saveSsoConfig(e.target, 'OIDC'); });
    jwtConfigForm.addEventListener('submit', (e) => { e.preventDefault(); saveSsoConfig(e.target, 'JWT'); });


    // --- "Test Attribute Login" (Dynamic Test) Function ---
    // *** THIS IS THE CORRECTED FUNCTION ***
    function testAttributes(providerId) {
        // This is the URL the browser will open in a popup
        // It is a public URL, so it won't be blocked by the 401 error.
        const url = `/api/sso/test-attributes/${providerId}`;

        // Open a new popup window for the SSO flow
        const popupWidth = 800;
        const popupHeight = 700;
        const left = (window.screen.width / 2) - (popupWidth / 2);
        const top = (window.screen.height / 2) - (popupHeight / 2);

        window.open(url, 'ssoTestPopup',
            `width=${popupWidth},height=${popupHeight},top=${top},left=${left},scrollbars=yes,resizable=yes`
        );
    }

    // --- REMOVED STATIC TEST CONNECTION FUNCTIONS ---

    // --- SSO Error Handling ---
    function getErrorDivForType(providerType) {
        if (providerType === 'SAML') return samlErrorDiv;
        if (providerType === 'OIDC') return oidcErrorDiv;
        if (providerType === 'JWT') return jwtErrorDiv;
        return errorMessageDiv;
    }
     function showSsoError(message, providerType = 'all') {
         const div = getErrorDivForType(providerType);
         if (div) { div.textContent = message; div.style.display = 'block'; }
     }
     function clearSsoErrors(providerType = 'all') {
         if (providerType === 'all' || providerType === 'SAML') { samlErrorDiv.textContent = ''; samlErrorDiv.style.display = 'none'; }
         if (providerType === 'all' || providerType === 'OIDC') { oidcErrorDiv.textContent = ''; oidcErrorDiv.style.display = 'none'; }
         if (providerType === 'all' || providerType === 'JWT') { jwtErrorDiv.textContent = ''; jwtErrorDiv.style.display = 'none'; }
     }

    // --- Error Handling Helpers ---
    function showError(message) { errorMessageDiv.textContent = message; errorMessageDiv.style.display = 'block'; }
    function clearErrors() { errorMessageDiv.textContent = ''; errorMessageDiv.style.display = 'none'; }
    function showModalError(message) { modalError.textContent = message; modalError.style.display = 'block'; }
    function clearModalError() { modalError.textContent = ''; modalError.style.display = 'none'; }
     async function handleApiError(response, actionDescription, showInModal = false, targetErrorDiv = null) {
         let errorDisplayDiv = showInModal ? modalError : (targetErrorDiv || errorMessageDiv);
         let errorMessage = `Failed to ${actionDescription} (Status: ${response.status})`;
         try {
             const errorData = await response.json();
             if (errorData.errors) errorMessage = "Validation Failed: " + Object.values(errorData.errors).join('; ');
             else errorMessage = errorData.message || errorMessage;
         } catch (e) { /* Ignore */ }
         console.error(`API Error during ${actionDescription}:`, errorMessage);
         if (response.status === 403) errorMessage = "Permission Denied. Check roles.";
         else if (response.status === 401) errorMessage = "Session Expired. Please log in.";
         if (errorDisplayDiv) { errorDisplayDiv.textContent = errorMessage; errorDisplayDiv.style.display = 'block'; }
         else { console.error("Target error div not found for message:", errorMessage); }
     }

    // --- Password Toggle Functionality ---
    function setupPasswordToggle(inputId, toggleId) {
        const passwordInput = document.getElementById(inputId);
        const toggleButton = document.getElementById(toggleId);
        if (passwordInput && toggleButton) {
            toggleButton.addEventListener('click', (e) => {
                e.preventDefault();
                const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput.setAttribute('type', type);
                toggleButton.textContent = type === 'password' ? 'Show' : 'Hide';
            });
        }
    }
    setupPasswordToggle('oidcClientSecret', 'toggleOidcSecret');
    setupPasswordToggle('jwtClientSecret', 'toggleJwtSecret');

    // --- Logout Functionality ---
    const logoutButton = document.getElementById('logout-button');
    if (logoutButton) {
        logoutButton.addEventListener('click', () => {
            localStorage.removeItem('accessToken');
            localStorage.removeItem('userInfo');
            window.location.href = '/login';
        });
    }

    // --- Initial Load ---
    if (token) {
        // Load the welcome tab by default, which is already set to active
    } else {
         showError("Authentication token not found. Please log in again.");
         // Disable tabs if no token
    }
    document.getElementById("welcome").style.display = "block";
</script>


</body>
</html>