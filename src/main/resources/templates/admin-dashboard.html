<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-orange: #FF6600;
            --secondary-orange: #FF9933;
            --sidebar-bg: #1c1e2f;
            --sidebar-text: #aeb9c0;
            --header-bg: #FFFFFF;
            --body-bg: #f3f4f6;
            --text-color: #333333;
            --border-color: #e5e7eb;
            --input-border: #d1d5db;
            --error-color: #DC3545;
            --success-color: #28a745;
            --link-color: #007bff;
            --input-focus-shadow: rgba(255, 102, 0, 0.2);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--body-bg);
            color: var(--text-color);
            height: 100vh;
            overflow: hidden;
        }

        /* --- LAYOUT --- */
        .dashboard-container { display: flex; height: 100vh; width: 100%; }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 260px; background-color: var(--sidebar-bg); display: flex; flex-direction: column; flex-shrink: 0; color: #fff;
        }
        .sidebar-header {
            height: 70px; display: flex; align-items: center; padding: 0 20px;
            background-color: var(--header-bg); border-bottom: 3px solid var(--primary-orange);
            color: var(--primary-orange); font-size: 1.3rem; font-weight: 700;
        }
        .header-logo-img { max-height: 32px; margin-right: 10px; display: none; }
        .sidebar-menu { list-style: none; padding: 0; margin: 20px 0 0 0; flex-grow: 1; overflow-y: auto; }
        .sidebar-menu li { width: 100%; }
        .nav-btn {
            width: 100%; text-align: left; background: transparent; border: none; color: var(--sidebar-text);
            padding: 12px 25px; font-size: 0.95rem; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: all 0.2s;
        }
        .nav-btn i { width: 20px; text-align: center; }
        .nav-btn:hover { background-color: rgba(255, 255, 255, 0.05); color: #fff; }
        .nav-btn.active { background-color: var(--primary-orange); color: #fff; font-weight: 500; }
        .sidebar-footer { padding: 20px; }
        .btn-logout-sidebar {
            width: 100%; background-color: #dc3545; color: white; border: none; padding: 10px; border-radius: 4px; cursor: pointer; font-weight: 500;
        }
        .btn-logout-sidebar:hover { background-color: #c82333; }

        /* --- MAIN CONTENT --- */
        .main-content { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        .top-header {
            height: 70px; background-color: var(--header-bg); border-bottom: 3px solid var(--primary-orange);
            display: flex; align-items: center; justify-content: space-between; padding: 0 30px; flex-shrink: 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); z-index: 10;
        }
        .admin-title { font-size: 1.2rem; font-weight: 600; color: #333; margin: 0; }
        .btn-dashboard {
            background-color: #6c757d; color: white; text-decoration: none; padding: 8px 15px; border-radius: 4px; font-size: 0.9rem; font-weight: 500;
        }
        .btn-dashboard:hover { background-color: #5a6268; }

        /* --- CONTENT --- */
        .content-area { padding: 30px; overflow-y: auto; height: 100%; }
        .tab-content {
            display: none; background-color: #fff; border: 1px solid var(--border-color); border-radius: 6px;
            padding: 40px; max-width: 900px; margin: 0 auto; box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .tab-content.active { display: block; }
        h2 { margin-top: 0; color: #333; font-size: 1.5rem; font-weight: 700; margin-bottom: 10px; }
        h4 { color: #333; font-weight: 600; margin-top: 25px; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px; }

        .form-row { display: flex; align-items: center; margin-bottom: 15px; }
        .form-row label { width: 220px; text-align: right; margin-right: 25px; font-weight: 500; font-size: 0.9rem; color: #555; flex-shrink: 0; }
        .form-row input[type=text], .form-row input[type=email], .form-row input[type=password], .form-row input[type=url], .form-row textarea, .form-row select {
            width: 100%; max-width: 350px; padding: 8px 12px; border: 1px solid var(--input-border); border-radius: 4px; font-size: 0.9rem; box-sizing: border-box;
        }
        .form-row input:focus, .form-row textarea:focus { outline: none; border-color: var(--primary-orange); box-shadow: 0 0 0 2px var(--input-focus-shadow); }
        textarea { min-height: 80px; resize: vertical; }

        .toggle-row { display: flex; align-items: center; margin-bottom: 15px; }
        .toggle-row label.main-lbl { width: 220px; text-align: right; margin-right: 25px; font-weight: 500; font-size: 0.9rem; color: #555; }
        .switch { position: relative; display: inline-block; width: 40px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-orange); }
        input:checked + .slider:before { transform: translateX(18px); }

        .btn-container { margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; text-align: right; }
        .btn-save { background-color: var(--primary-orange); color: white; padding: 8px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 0.9rem; }
        .btn-save:hover { background-color: #e65c00; }
        .btn-test { background-color: #fff; border: 1px solid #ddd; color: #333; padding: 8px 20px; border-radius: 4px; cursor: pointer; margin-right: 10px; font-weight: 500; font-size: 0.9rem; }
        .btn-test:hover { background-color: #f8f8f8; }
        .btn-create { background-color: #28a745; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; font-weight: 500; display: flex; align-items: center; gap: 8px; }

        .password-wrapper { position: relative; width: 100%; max-width: 350px; }
        .password-wrapper input { width: 100%; padding-right: 60px; }
        .toggle-password { position: absolute; right: 5px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--primary-orange); font-size: 0.8rem; font-weight: 600; cursor: pointer; }

        .url-display-box { background-color: #f8f9fa; border: 1px solid var(--border-color); border-radius: 6px; padding: 15px; margin-top: 20px; }
        .url-display-box label { font-weight: 600; color: #333; display: block; margin-bottom: 5px; font-size: 0.85rem; }
        .url-display-box code { display: block; background-color: #fff; padding: 8px; border-radius: 4px; border: 1px solid #ddd; font-size: 0.85rem; color: #e83e8c; word-break: break-all; margin-bottom: 10px; }

        /* User Table */
        .user-management-container { padding: 0; border: none; background: transparent; box-shadow: none; max-width: 100%; }
        .table-wrapper { background-color: #fff; border-radius: 8px; border: 1px solid var(--border-color); box-shadow: 0 1px 3px rgba(0,0,0,0.05); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin: 0; }
        th { background-color: #f9fafb; color: #6b7280; font-weight: 600; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.5px; padding: 16px 24px; text-align: left; border-bottom: 1px solid var(--border-color); }
        td { padding: 16px 24px; border-bottom: 1px solid #f3f4f6; color: #374151; font-size: 0.9rem; vertical-align: middle; }
        tr:last-child td { border-bottom: none; }
        tr:hover { background-color: #f9fafb; }
        .action-cell { display: flex; gap: 8px; }
        .btn-icon { width: 32px; height: 32px; border-radius: 4px; border: 1px solid transparent; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; background: transparent; }
        .btn-icon.edit { color: var(--primary-orange); background-color: #fff7ed; border-color: #ffedd5; }
        .btn-icon.delete { color: #ef4444; background-color: #fef2f2; border-color: #fee2e2; }

        /* Modal & Toast */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fff; margin: 10% auto; padding: 25px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 8px; position: relative; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: #fff; color: #333; padding: 15px 25px; border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 12px; animation: slideIn 0.3s ease-out forwards; border-left: 4px solid #ccc; min-width: 300px; font-size: 0.95rem; }
        .toast.success { border-left-color: var(--success-color); }
        .toast.error { border-left-color: var(--error-color); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { to { opacity: 0; transform: translateX(100%); } }
    </style>
</head>
<body>

<div id="toast-container" class="toast-container"></div>

<div class="dashboard-container">
    <div class="sidebar">
        <div class="sidebar-header">
            <img src="" alt="Logo" class="header-logo-img" id="header-logo" />
            <span id="header-logo-text">Admin Panel</span>
        </div>
        <ul class="sidebar-menu">
            <li><button class="nav-btn active" onclick="openTab(event, 'welcome')"><i class="fas fa-home"></i> Welcome</button></li>
            <li><button class="nav-btn" onclick="openTab(event, 'brandingConfig')"><i class="fas fa-paint-brush"></i> Branding & Domain</button></li>
            <li><button class="nav-btn" onclick="openTab(event, 'userManagement')"><i class="fas fa-users"></i> User Management</button></li>
            <li><button class="nav-btn" onclick="openTab(event, 'samlConfig')"><i class="fas fa-key"></i> SAML Config</button></li>
            <li><button class="nav-btn" onclick="openTab(event, 'oidcConfig')"><i class="fab fa-openid"></i> OIDC Config</button></li>
            <li><button class="nav-btn" onclick="openTab(event, 'jwtConfig')"><i class="fas fa-shield-alt"></i> JWT Config</button></li>
        </ul>
        <div class="sidebar-footer">
            <button id="logout-button" class="btn-logout-sidebar">Logout</button>
        </div>
    </div>

    <div class="main-content">
        <div class="top-header">
            <div class="admin-title">Configuration Dashboard</div>
            <a href="/dashboard" class="btn-dashboard">Go to User Dashboard</a>
        </div>

        <div class="content-area">
            <div id="welcome" class="tab-content active">
                <h2>Welcome, Customer Admin!</h2>
                <p>Use the sidebar to manage your organization's users, configure Single Sign-On providers, or set up your branding.</p>
                <h4 style="margin-top: 30px;">How to Test Your SSO Configuration:</h4>
                <ol style="line-height: 1.8; color: #555; margin-left: 20px; padding: 0;">
                    <li>Go to the "Branding & Domain" tab and set your unique subdomain.</li>
                    <li>Configure and save an SSO provider (e.g., OIDC, SAML, or JWT).</li>
                    <li>Click the <strong>"Test Connection"</strong> button. This will open a new popup window.</li>
                    <li>Perform a real SSO login as a test user in that popup window.</li>
                    <li>The popup window will refresh and show you a "TEST SUCCESSFUL" message.</li>
                </ol>
            </div>

            <div id="brandingConfig" class="tab-content">
                <h2>Branding & Domain</h2>
                <form id="brandingConfigForm">
                    <div class="form-row"><label for="brandingSubdomain">Branding Name (Subdomain)</label><input type="text" id="brandingSubdomain" placeholder="e.g., acme-corp" required></div>
                    <div style="margin-left: 245px; margin-top: -10px; font-size: 0.85rem; color: #888; margin-bottom: 15px;">
                        Login URL: <code>https://<span id="subdomain-preview">your-name</span>.prajwal.cfd/login</code>
                    </div>
                    <div class="form-row"><label for="brandingLogoUrl">Logo URL (Optional)</label><input type="url" id="brandingLogoUrl" placeholder="https://example.com/logo.png"></div>
                    <div class="form-row"><label for="brandingPrimaryColor">Primary Color (Hex)</label><input type="text" id="brandingPrimaryColor" placeholder="#FF6600"></div>
                    <div class="btn-container"><button type="submit" class="btn-save">Save Branding Settings</button></div>
                </form>
            </div>

            <div id="userManagement" class="user-management-container" style="display: none; padding: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0; color: #333;">User Management</h2>
                    <button onclick="openCreateModal()" class="btn-create"><i class="fas fa-plus"></i> Create New User</button>
                </div>
                <div class="table-wrapper">
                    <table id="user-table">
                        <thead>
                        <tr><th style="width: 5%;">ID</th> <th style="width: 15%;">Username</th> <th style="width: 25%;">Email</th> <th style="width: 15%;">Name</th> <th style="width: 15%;">Roles</th> <th style="width: 10%;">Provider</th> <th style="width: 15%;">Actions</th></tr>
                        </thead>
                        <tbody><tr><td colspan="7" style="text-align:center;">Loading users...</td></tr></tbody>
                    </table>
                </div>
            </div>

            <div id="samlConfig" class="tab-content">
                <h2>SAML Configuration</h2>
                <form id="samlConfigForm" class="sso-form" data-provider-type="SAML" data-provider-id="saml_miniorange">
                    <input type="hidden" id="samlConfigId">
                    <div class="toggle-row"><label class="main-lbl" for="samlEnable">Enable SAML Provider</label><label class="switch"><input type="checkbox" id="samlEnable"><span class="slider"></span></label></div>
                    <div class="form-row"><label for="samlDisplayName">Display Name</label><input type="text" id="samlDisplayName" placeholder="e.g., Okta SAML"></div>
                    <h4>Identity Provider Details</h4>
                    <div class="form-row"><label for="samlEntityId">IdP Entity ID</label><input type="text" id="samlEntityId" placeholder="https://idp.example.com/entityid"></div>
                    <div class="form-row"><label for="samlSsoUrl">SSO URL</label><input type="url" id="samlSsoUrl" placeholder="https://idp.example.com/sso"></div>
                    <div class="form-row"><label for="samlCertificate">X.509 Certificate</label><textarea id="samlCertificate" placeholder="Paste certificate here..."></textarea></div>
                    <div class="btn-container">
                        <button type="button" class="btn-test" onclick="testAttributes('saml_miniorange')">Test Connection</button>
                        <button type="submit" class="btn-save">Save SAML Config</button>
                    </div>
                </form>
                <div class="url-display-box">
                    <h4>Your Service Provider (SP) URLs</h4>
                    <label>SP Entity ID:</label><code>https://<span class="dynamic-subdomain">your-subdomain</span>.prajwal.cfd/saml2/service-provider-metadata/saml_miniorange</code>
                    <label>ACS URL:</label><code>https://<span class="dynamic-subdomain">your-subdomain</span>.prajwal.cfd/login/saml2/sso/saml_miniorange</code>
                </div>
            </div>

            <div id="oidcConfig" class="tab-content">
                <h2>OIDC Configuration</h2>
                <form id="oidcConfigForm" class="sso-form" data-provider-type="OIDC" data-provider-id="oidc_miniorange">
                    <input type="hidden" id="oidcConfigId">
                    <div class="toggle-row"><label class="main-lbl" for="oidcEnable">Enable OIDC Provider</label><label class="switch"><input type="checkbox" id="oidcEnable"><span class="slider"></span></label></div>
                    <div class="form-row"><label for="oidcDisplayName">Display Name</label><input type="text" id="oidcDisplayName" placeholder="e.g., Google Workspace"></div>
                    <h4>Identity Provider Details</h4>
                    <div class="form-row"><label for="oidcIssuerUri">Issuer URI</label><input type="url" id="oidcIssuerUri" placeholder="Leave blank to use discovery"></div>
                    <div class="form-row"><label for="oidcClientId">Client ID</label><input type="text" id="oidcClientId"></div>
                    <div class="form-row"><label for="oidcClientSecret">Client Secret</label><div class="password-wrapper"><input type="password" id="oidcClientSecret"><button type="button" class="toggle-password" id="toggleOidcSecret">Show</button></div></div>
                    <div class="form-row"><label for="oidcScopes">Scopes</label><input type="text" id="oidcScopes" value="openid, profile, email"></div>
                    <div class="form-row"><label for="oidcUserNameAttribute">User Name Attribute</label><input type="text" id="oidcUserNameAttribute" value="email"></div>
                    <h4>Endpoint Overrides</h4>
                    <div class="form-row"><label for="oidcAuthorizationUri">Auth Endpoint</label><input type="url" id="oidcAuthorizationUri"></div>
                    <div class="form-row"><label for="oidcTokenUri">Token Endpoint</label><input type="url" id="oidcTokenUri"></div>
                    <div class="form-row"><label for="oidcUserInfoUri">UserInfo Endpoint</label><input type="url" id="oidcUserInfoUri"></div>
                    <div class="form-row"><label for="oidcJwkSetUri">JWK Set URI</label><input type="url" id="oidcJwkSetUri"></div>
                    <div class="btn-container">
                        <button type="button" class="btn-test" onclick="testAttributes('oidc_miniorange')">Test Connection</button>
                        <button type="submit" class="btn-save">Save OIDC Config</button>
                    </div>
                </form>
                <div class="url-display-box">
                    <h4>Your OIDC Redirect URI</h4>
                    <label>Redirect URI:</label><code>https://<span class="dynamic-subdomain">your-subdomain</span>.prajwal.cfd/login/oauth2/code/oidc_miniorange</code>
                </div>
            </div>

            <div id="jwtConfig" class="tab-content">
                <h2>JWT Configuration</h2>
                <form id="jwtConfigForm" class="sso-form" data-provider-type="JWT" data-provider-id="jwt_miniorange">
                    <input type="hidden" id="jwtConfigId">
                    <div class="toggle-row"><label class="main-lbl" for="jwtEnable">Enable JWT Provider</label><label class="switch"><input type="checkbox" id="jwtEnable"><span class="slider"></span></label></div>
                    <div class="form-row"><label for="jwtDisplayName">Display Name</label><input type="text" id="jwtDisplayName" placeholder="e.g., MiniOrange JWT"></div>
                    <h4>Identity Provider Details</h4>
                    <div class="form-row"><label for="jwtSsoUrl">JWT SSO URL (Full Link)</label><input type="url" id="jwtSsoUrl" placeholder="https://idp.example.com/jwtsso/...?client_id=..."></div>
                    <div class="form-row"><label for="jwtClientId">Client ID</label><input type="text" id="jwtClientId"></div>
                    <div class="form-row"><label for="jwtClientSecret">Client Secret</label><div class="password-wrapper"><input type="password" id="jwtClientSecret"><button type="button" class="toggle-password" id="toggleJwtSecret">Show</button></div></div>
                    <div class="form-row"><label for="jwtCertificate">Certificate (PEM)</label><textarea id="jwtCertificate"></textarea></div>

                    <div class="btn-container">
                        <button type="button" class="btn-test" onclick="testAttributes('jwt_miniorange')">Test Connection</button>
                        <button type="submit" class="btn-save">Save JWT Config</button>
                    </div>
                </form>
                <div class="url-display-box">
                    <h4>Service Provider (SP) / Redirect URL</h4>
                    <label>Redirect URI:</label>
                    <code>https://<span class="dynamic-subdomain">your-subdomain</span>.prajwal.cfd/login/jwt/callback</code>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="userModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2 id="modalTitle">User Form</h2>
        <form id="userForm">
            <input type="hidden" id="userId">
            <div class="form-row"><label>Username</label><input type="text" id="username" required></div>
            <div class="form-row"><label>Email</label><input type="email" id="email" required></div>
            <div class="form-row"><label>Password</label><div class="password-wrapper"><input type="password" id="password"><button type="button" class="toggle-password" id="toggleUserPassword">Show</button></div></div>
            <div class="form-row"><label>First Name</label><input type="text" id="firstName"></div>
            <div class="form-row"><label>Last Name</label><input type="text" id="lastName"></div>
            <div class="form-row"><label>Roles</label><input type="text" id="roles" placeholder="ROLE_USER,ROLE_ADMIN"></div>
            <div class="btn-container"><button type="submit" class="btn-save">Save User</button></div>
        </form>
    </div>
</div>

<script>
    function showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `<i class="${type==='success'?'fas fa-check-circle':'fas fa-exclamation-circle'}" style="color:${type==='success'?'var(--success-color)':'var(--error-color)'}"></i> <span>${message}</span>`;
        container.appendChild(toast);
        setTimeout(() => { toast.style.animation = 'fadeOut 0.3s ease-in forwards'; toast.addEventListener('animationend', () => toast.remove()); }, 3000);
    }

    const token = localStorage.getItem('accessToken');
    const userTableBody = document.getElementById('user-table').getElementsByTagName('tbody')[0];
    const modal = document.getElementById('userModal');
    const modalTitle = document.getElementById('modalTitle');
    const userForm = document.getElementById('userForm');
    const userIdInput = document.getElementById('userId');
    const brandingForm = document.getElementById('brandingConfigForm');
    const brandingSubdomainInput = document.getElementById('brandingSubdomain');
    const brandingLogoUrlInput = document.getElementById('brandingLogoUrl');
    const brandingPrimaryColorInput = document.getElementById('brandingPrimaryColor');
    const subdomainPreview = document.getElementById('subdomain-preview');
    let configDataStore = {};

    (async function init() {
        if (!token) { window.location.href = '/login'; return; }
        try {
            const res = await fetch('/api/public/branding', { headers: { 'Authorization': 'Bearer ' + token } });
            if (res.ok) {
                const b = await res.json();
                if (b.brandingLogoUrl) document.getElementById('header-logo').src = b.brandingLogoUrl;
                if (b.tenantName) document.getElementById('header-logo-text').textContent = `${b.tenantName} Admin Panel`;
                if (b.brandingPrimaryColor) document.documentElement.style.setProperty('--primary-orange', b.brandingPrimaryColor);
            }
        } catch (e) {}
        await loadBrandingSettings();
    })();

    window.openTab = function(evt, tabName) {
        document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
        document.getElementById("userManagement").style.display = "none";
        document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(tabName).style.display = 'block';
        if (evt && evt.currentTarget) evt.currentTarget.classList.add('active');
        if (tabName === 'userManagement') loadUsers();
        else if (['samlConfig', 'oidcConfig', 'jwtConfig'].includes(tabName)) {
            loadSsoConfigurations();
            updateDynamicSubdomainUrls(brandingSubdomainInput.value);
        }
    };

    function updateDynamicSubdomainUrls(sub) {
        const txt = sub ? sub.trim().toLowerCase().replaceAll(' ', '-') : 'your-subdomain';
        if(subdomainPreview) subdomainPreview.textContent = txt;
        document.querySelectorAll('.dynamic-subdomain').forEach(el => el.textContent = txt);
    }

    async function loadBrandingSettings() {
        try {
            const res = await fetch('/api/admin/branding', { headers: { 'Authorization': 'Bearer ' + token } });
            if (res.ok) {
                const b = await res.json();
                brandingSubdomainInput.value = b.subdomain || '';
                brandingLogoUrlInput.value = b.brandingLogoUrl || '';
                brandingPrimaryColorInput.value = b.brandingPrimaryColor || '';
                updateDynamicSubdomainUrls(b.subdomain);
            }
        } catch (e) {}
    }

    brandingSubdomainInput.addEventListener('input', (e) => { updateDynamicSubdomainUrls(e.target.value); });

    brandingForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
            const res = await fetch('/api/admin/branding', { method: 'PUT', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token }, body: JSON.stringify({ subdomain: brandingSubdomainInput.value, brandingLogoUrl: brandingLogoUrlInput.value, brandingPrimaryColor: brandingPrimaryColorInput.value }) });
            if (!res.ok) throw new Error((await res.json()).message || 'Failed');
            const b = await res.json();
            showToast(`Branding updated!`, 'success');
            document.documentElement.style.setProperty('--primary-orange', b.brandingPrimaryColor || '#FF6600');
            if (b.brandingLogoUrl) document.getElementById('header-logo').src = b.brandingLogoUrl;
            updateDynamicSubdomainUrls(b.subdomain);
        } catch (e) { showToast(e.message, 'error'); }
    });

    async function loadUsers() {
        userTableBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Loading...</td></tr>';
        try {
            const res = await fetch('/api/admin/users', { headers: { 'Authorization': 'Bearer ' + token } });
            if (res.ok) {
                const users = await res.json();
                userTableBody.innerHTML = '';
                if(!users.length) userTableBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">No users found.</td></tr>';
                users.forEach(u => {
                    const row = userTableBody.insertRow();
                    row.innerHTML = `<td><strong>${u.id}</strong></td><td>${u.username}</td><td>${u.email}</td><td>${(u.firstName||'')+' '+(u.lastName||'')}</td><td><span style="background:#eff6ff; color:#1d4ed8; padding:2px 8px; border-radius:10px; font-size:0.75rem;">${u.roles||'USER'}</span></td><td>${u.authProvider}</td><td class="action-cell"><button class="btn-icon edit" onclick="openEditModal(${u.id})"><i class="fas fa-pen"></i></button><button class="btn-icon delete" onclick="deleteUser(${u.id})"><i class="fas fa-trash"></i></button></td>`;
                });
            }
        } catch (e) { showToast(e.message, 'error'); }
    }

    window.openCreateModal = function() { userForm.reset(); userIdInput.value = ''; modalTitle.textContent = 'Create New User'; document.getElementById('password').placeholder = "Required"; modal.style.display = "block"; };
    window.openEditModal = async function(id) {
        try {
            const res = await fetch(`/api/admin/users/${id}`, { headers: { 'Authorization': 'Bearer ' + token } });
            if (res.ok) {
                const u = await res.json();
                userIdInput.value = u.id; document.getElementById('username').value = u.username; document.getElementById('email').value = u.email; document.getElementById('firstName').value = u.firstName || ''; document.getElementById('lastName').value = u.lastName || ''; document.getElementById('roles').value = u.roles || '';
                document.getElementById('password').placeholder = "Leave blank if no change"; modalTitle.textContent = 'Edit User: ' + u.username; modal.style.display = "block";
            }
        } catch (e) { showToast(e.message, 'error'); }
    };
    window.deleteUser = async function(id) {
        if (!confirm('Delete this user?')) return;
        try { await fetch(`/api/admin/users/${id}`, { method: 'DELETE', headers: { 'Authorization': 'Bearer ' + token } }); showToast('User deleted', 'success'); loadUsers(); } catch (e) { showToast(e.message, 'error'); }
    };
    window.closeModal = function() { modal.style.display = "none"; };
    userForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = userIdInput.value;
        const data = { username: document.getElementById('username').value, email: document.getElementById('email').value, firstName: document.getElementById('firstName').value, lastName: document.getElementById('lastName').value, roles: document.getElementById('roles').value };
        if (document.getElementById('password').value) data.password = document.getElementById('password').value;
        try {
            const res = await fetch(id ? `/api/admin/users/${id}` : '/api/admin/users', { method: id ? 'PUT' : 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token }, body: JSON.stringify(data) });
            if (!res.ok) throw new Error((await res.json()).message);
            closeModal(); showToast('User saved', 'success'); loadUsers();
        } catch (e) { showToast(e.message, 'error'); }
    });

    async function loadSsoConfigurations() {
        try {
            const res = await fetch('/api/admin/sso-config', { headers: { 'Authorization': 'Bearer ' + token } });
            if (res.ok) {
                (await res.json()).forEach(c => { configDataStore[c.providerId] = c; populateSsoForm(c); });
            }
        } catch (e) {}
    }

    function populateSsoForm(c) {
        const p = c.providerType.toLowerCase();
        const idEl = document.getElementById(`${p}ConfigId`);
        if (!idEl) return;
        idEl.value = c.id || '';
        document.getElementById(`${p}Enable`).checked = c.enabled;
        document.getElementById(`${p}DisplayName`).value = c.displayName || '';
        if (document.getElementById(`${p}ClientId`)) document.getElementById(`${p}ClientId`).value = c.clientId || '';
        if (document.getElementById(`${p}ClientSecret`)) document.getElementById(`${p}ClientSecret`).value = '';
        if (document.getElementById(`${p}IssuerUri`)) document.getElementById(`${p}IssuerUri`).value = c.issuerUri || '';
        if (p === 'jwt') {
            document.getElementById('jwtSsoUrl').value = c.jwtSsoUrl || '';
            document.getElementById('jwtCertificate').value = c.jwtCertificate || '';
            // Map Issuer to Client ID field if present (common usage)
            if (c.issuerUri) document.getElementById('jwtClientId').value = c.issuerUri;
        }
        // ... (Mapping other fields for SAML/OIDC - same as before) ...
        if (p === 'saml') { document.getElementById('samlEntityId').value = c.samlEntityId||''; document.getElementById('samlSsoUrl').value = c.samlSsoUrl||''; document.getElementById('samlCertificate').value = c.samlCertificate||''; }
        if (p === 'oidc') { document.getElementById('oidcScopes').value = c.scopes||''; document.getElementById('oidcUserNameAttribute').value = c.userNameAttribute||''; if(c.authorizationUri) document.getElementById('oidcAuthorizationUri').value = c.authorizationUri; if(c.tokenUri) document.getElementById('oidcTokenUri').value = c.tokenUri; if(c.userInfoUri) document.getElementById('oidcUserInfoUri').value = c.userInfoUri; if(c.jwkSetUri) document.getElementById('oidcJwkSetUri').value = c.jwkSetUri; }
    }

    ['saml', 'oidc', 'jwt'].forEach(type => {
        const form = document.getElementById(`${type}ConfigForm`);
        // Clean clones
        const newForm = form.cloneNode(true);
        form.parentNode.replaceChild(newForm, form);

        newForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const pid = newForm.dataset.providerId;
            const cfgId = configDataStore[pid]?.id;
            const data = {
                id: cfgId, providerId: pid, providerType: type.toUpperCase(),
                enabled: document.getElementById(`${type}Enable`).checked,
                displayName: document.getElementById(`${type}DisplayName`).value
            };
            // Mapping fields manually to ensure JWT special case is handled
            if (type === 'jwt') {
                data.jwtSsoUrl = document.getElementById('jwtSsoUrl').value;
                data.jwtCertificate = document.getElementById('jwtCertificate').value;
                // Important: For JWT, Client ID field maps to Issuer URI
                data.issuerUri = document.getElementById('jwtClientId').value;
                // Pass Client ID as well if backend needs it separately
                data.clientId = document.getElementById('jwtClientId').value;

                // Construct Redirect URI to ensure it is saved
                const sub = document.getElementById('brandingSubdomain').value || 'example';
                data.jwtRedirectUri = `https://${sub}.prajwal.cfd/login/jwt/callback`;
            } else {
                // Standard mapping for OIDC/SAML
                if(document.getElementById(`${type}ClientId`)) data.clientId = document.getElementById(`${type}ClientId`).value;
                if(document.getElementById(`${type}IssuerUri`)) data.issuerUri = document.getElementById(`${type}IssuerUri`).value;
                if(type==='saml') { data.samlEntityId=document.getElementById('samlEntityId').value; data.samlSsoUrl=document.getElementById('samlSsoUrl').value; data.samlCertificate=document.getElementById('samlCertificate').value; }
                if(type==='oidc') { data.scopes=document.getElementById('oidcScopes').value; data.userNameAttribute=document.getElementById('oidcUserNameAttribute').value; data.authorizationUri=document.getElementById('oidcAuthorizationUri').value; data.tokenUri=document.getElementById('oidcTokenUri').value; data.userInfoUri=document.getElementById('oidcUserInfoUri').value; data.jwkSetUri=document.getElementById('oidcJwkSetUri').value; }
            }

            // Password handling
            const secretEl = document.getElementById(`${type}ClientSecret`);
            if(secretEl && secretEl.value) data.clientSecret = secretEl.value;

            try {
                const res = await fetch(cfgId ? `/api/admin/sso-config/${cfgId}` : '/api/admin/sso-config', { method: cfgId ? 'PUT' : 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token }, body: JSON.stringify(data) });
                if (!res.ok) throw new Error((await res.json()).message);
                const updated = await res.json();
                configDataStore[pid] = updated;
                populateSsoForm(updated);
                showToast(`${type.toUpperCase()} Saved!`, 'success');
            } catch (e) { showToast(e.message, 'error'); }
        });
    });

    window.testAttributes = function(pid) {
        const c = configDataStore[pid];
        if (!c || !c.enabled) { showToast("Please save and enable configuration first.", 'error'); return; }
        window.open(`/api/sso/test-attributes/${pid}`, 'test', 'width=600,height=700');
    };

    document.querySelectorAll('.toggle-password').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const inp = e.target.previousElementSibling;
            inp.type = inp.type === 'password' ? 'text' : 'password';
            e.target.textContent = inp.type === 'password' ? 'Show' : 'Hide';
        });
    });

    document.getElementById('logout-button').addEventListener('click', () => { localStorage.removeItem('accessToken'); window.location.href = '/login'; });
    if (token) document.getElementById("welcome").style.display = "block"; else window.location.href = '/login';
</script>
</body>
</html>