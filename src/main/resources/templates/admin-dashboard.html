<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard</title>
    <style>
        :root {
            --primary-orange: #FF6600;
            --secondary-orange: #FF9933;
            --background-color: #F8F8F8;
            --form-background: #FFFFFF;
            --text-color: #333333;
            --border-color: #DDDDDD;
            --error-color: #DC3545;
            --success-color: #28a745;
            --link-color: #007bff;
            --tab-inactive-bg: #E9ECEF;
            --tab-active-bg: var(--form-background);
            --tab-active-border: var(--primary-orange);
            --input-focus-border: var(--primary-orange);
            --input-focus-shadow: rgba(255, 102, 0, 0.2);
            --toggle-bg-off: #ccc;
            --toggle-bg-on: var(--primary-orange);
            --toggle-knob: white;
        }

        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 0; margin: 0; background-color: var(--background-color); color: var(--text-color); }
        h1, h2, h3 { color: var(--primary-orange); font-weight: 600; margin-bottom: 10px; }
        h4 { color: var(--text-color); font-weight: 600; margin-top: 25px; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; }

        .admin-container { padding: 20px 30px; }
        .admin-header { display: flex; justify-content: space-between; align-items: center; background-color: #fff; padding: 10px 30px; border-bottom: 2px solid var(--primary-orange); box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }

        .header-logo-img { max-height: 40px; margin-right: 15px; display: none; }
        .header-logo-text { font-size: 1.5em; margin: 0; color: var(--primary-orange); font-weight: 600; }

        .admin-nav a, .admin-nav button { margin-left: 15px; text-decoration: none; padding: 8px 15px; border-radius: 4px; font-size: 0.9em; }
        .admin-nav .button-link { background-color: #6c757d; color: white; border: none; }
        .admin-nav .btn-logout { background-color: var(--link-color); color: white; border: none; cursor: pointer; }

        .tab-nav { border-bottom: 1px solid var(--border-color); padding-left: 0; margin-bottom: 20px; list-style: none; display: flex; flex-wrap: wrap; }
        .tab-nav li { margin-right: 5px; margin-bottom: -1px; }
        .tab-nav button { background-color: var(--tab-inactive-bg); border: 1px solid var(--border-color); border-bottom: none; padding: 10px 15px; cursor: pointer; border-radius: 6px 6px 0 0; font-size: 0.95em; font-weight: 500; color: var(--text-color); transition: background-color 0.2s; }
        .tab-nav button:hover { background-color: #ddd; }
        .tab-nav button.active { background-color: var(--tab-active-bg); border-color: var(--border-color); border-bottom: 1px solid var(--tab-active-bg); position: relative; top: 1px; color: var(--primary-orange); font-weight: 600; }
        .tab-nav button.active::after { content: ''; position: absolute; bottom: -1px; left: 0; right: 0; height: 3px; background-color: var(--tab-active-border); }
        .tab-content { display: none; padding: 20px; background-color: var(--form-background); border: 1px solid var(--border-color); border-radius: 0 8px 8px 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .tab-content.active { display: block; }

        table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 20px; background-color: var(--form-background); border-radius: 8px; overflow: hidden; }
        th, td { border: 1px solid var(--border-color); padding: 12px; text-align: left; font-size: 0.9em; }
        th { background-color: #EFEFEF; font-weight: 600; border-bottom: 2px solid var(--primary-orange); }
        tr:nth-child(even) { background-color: #F8F8F8; }

        button, .button-link { margin: 5px 2px; padding: 8px 15px; border-radius: 4px; border: none; font-size: 0.9em; cursor: pointer; }
        .btn-create { background-color: #28a745; color: white; }
        .btn-edit { background-color: var(--secondary-orange); color: var(--text-color); }
        .btn-delete { background-color: var(--error-color); color: white; }
        .btn-save { background-color: var(--primary-orange); color: white; margin-top: 10px; }
        .btn-test { background-color: var(--success-color); color: white; margin-top: 10px; margin-left: 10px;}

        .sso-form { margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px dashed var(--border-color); }
        .sso-form:last-child { border-bottom: none; }
        label { display: block; margin-bottom: 8px; font-weight: 500; font-size: 0.95em; }
        input[type=text], input[type=email], input[type=password], input[type=url], textarea, select { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 1em; box-sizing: border-box; background-color: #fff; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: var(--input-focus-border); box-shadow: 0 0 0 2px var(--input-focus-shadow); }
        textarea { min-height: 80px; resize: vertical; font-family: inherit; }
        .form-row { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 0; }
        .form-row > div { flex: 1; min-width: 200px; }
        .toggle-switch { display: flex; align-items: center; margin-bottom: 15px; }
        .toggle-switch label { margin-right: 10px; margin-bottom: 0; }
        .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--toggle-bg-off); transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: var(--toggle-knob); transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--toggle-bg-on); }
        input:checked + .slider:before { transform: translateX(26px); }

        .error { color: var(--error-color); background-color: #f8d7da; padding: 10px; border-radius: 4px; margin-bottom: 15px; }
        .success-message { color: var(--success-color); background-color: #d4edda; padding: 10px; border-radius: 4px; margin-bottom: 15px; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: var(--form-background); margin: 10% auto; padding: 25px; border: 1px solid #888; width: 90%; max-width: 550px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .close { color: #aaa; float: right; font-size: 30px; font-weight: bold; cursor: pointer; line-height: 1; }

        .password-wrapper { position: relative; display: flex; align-items: center; width: 100%; margin-bottom: 15px; }
        .password-wrapper input { padding-right: 65px; margin-bottom: 0; }
        .toggle-password { position: absolute; right: 1px; top: 1px; bottom: 1px; border: none; background: #f0f0f0; color: var(--text-color); padding: 0 10px; cursor: pointer; font-size: 0.8em; font-weight: 600; border-radius: 0 4px 4px 0; z-index: 2; width: 60px; }
        .toggle-password:hover { background: #e0e0e0; }

        .form-hint { font-size: 0.85em; color: #6c757d; margin-top: -10px; margin-bottom: 15px; }
        .form-hint code { background-color: #e9ecef; padding: 2px 4px; border-radius: 3px; }

        /* --- NEW STYLES FOR URL DISPLAY --- */
        .url-display-box {
            background-color: #f8f9fa;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 15px;
            margin-top: 10px;
            margin-bottom: 25px; /* Space it out */
        }
        .url-display-box label {
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        .url-display-box code {
            display: block; /* Make it take its own line */
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            font-size: 0.9em;
            color: #333;
            word-break: break-all; /* Handle long URLs */
            margin-bottom: 10px; /* Space between URLs */
        }
        .url-display-box code:last-child {
            margin-bottom: 0;
        }
        .dynamic-subdomain {
            color: var(--primary-orange);
            font-weight: bold;
        }
        /* --- END NEW STYLES --- */
    </style>
</head>
<body>

<div class="admin-header">
    <div>
        <img src="" alt="Logo" class="header-logo-img" id="header-logo" />
        <h1 class="header-logo-text" id="header-logo-text">Admin Panel</h1>
    </div>
    <div class="admin-nav">
        <a href="/dashboard" class="button-link">Go to User Dashboard</a>
        <button id="logout-button" class="btn-logout">Logout</button>
    </div>
</div>

<div class="admin-container">
    <ul class="tab-nav">
        <li><button class="tab-button active" onclick="openTab(event, 'welcome')">Welcome</button></li>
        <li><button class="tab-button" onclick="openTab(event, 'brandingConfig')">Branding & Domain</button></li>
        <li><button class="tab-button" onclick="openTab(event, 'userManagement')">User Management</button></li>
        <li><button class="tab-button" onclick="openTab(event, 'samlConfig')">SAML Config</button></li>
        <li><button class="tab-button" onclick="openTab(event, 'oidcConfig')">OIDC Config</button></li>
        <li><button class="tab-button" onclick="openTab(event, 'jwtConfig')">JWT Config</button></li>
        <li><button class="tab-button" onclick="openTab(event, 'kerberosConfig')">Kerberos Config</button></li>
    </ul>

    <div id="welcome" class="tab-content active">
        <h2>Welcome, Customer Admin!</h2>
        <p>Use the tabs above to manage your organization's users, configure Single Sign-On providers, or set up your branding.</p>
        <h4>How to Test Your SSO Configuration:</h4>
        <ol>
            <li>Go to the "Branding & Domain" tab and set your unique subdomain.</li>
            <li>Configure and save an SSO provider (e.g., OIDC, SAML, or JWT).</li>
            <li>Click the **"Test Connection"** button. This will open a new popup window.</li>
            <li>Perform a real SSO login as a test user *in that popup window*.</li>
            <li>The popup window will refresh and show you a "TEST SUCCESSFUL" message.</li>
        </ol>
    </div>

    <div id="brandingConfig" class="tab-content">
        <h2>Branding & Domain</h2>
        <p>Customize your organization's login page and set your unique login URL.</p>
        <div id="branding-error-message" class="error" style="display: none;"></div>
        <div id="branding-success-message" class="success-message" style="display: none;"></div>

        <form id="brandingConfigForm">
            <div>
                <label for="brandingSubdomain">Branding Name (Subdomain):</label>
                <input type="text" id="brandingSubdomain" placeholder="e.g., acme-corp" required>
                <p class="form-hint">Your unique login URL: Code <span id="subdomain-preview">your-name</span>.prajwal.cfd/login</p>
            </div>
            <div>
                <label for="brandingLogoUrl">Logo URL (Optional):</label>
                <input type="url" id="brandingLogoUrl" placeholder="https://example.com/logo.png">
                <p class="form-hint">Provide a direct URL to your company's logo.</p>
            </div>
            <div>
                <label for="brandingPrimaryColor">Primary Color (Optional):</label>
                <input type="text" id="brandingPrimaryColor" placeholder="#FF6600">
                <p class="form-hint">Enter a hex color code (e.g., <code>#007bff</code>) to theme your login page.</p>
            </div>

            <button type="submit" class="btn-save">Save Branding Settings</button>
        </form>
    </div>

    <div id="userManagement" class="tab-content">
        <h2>User Management</h2>
        <button onclick="openCreateModal()" class="btn-create">Create New User</button>
        <div id="error-message" class="error" style="display: none;"></div>
        <table id="user-table">
            <thead><tr><th>ID</th><th>Username</th><th>Email</th><th>First Name</th><th>Last Name</th><th>Roles</th><th>Provider</th><th>Actions</th></tr></thead>
            <tbody><tr><td colspan="8">Loading users...</td></tr></tbody>
        </table>
    </div>

    <div id="samlConfig" class="tab-content">
        <h2>SAML Configuration</h2>
        <div id="saml-error-message" class="error" style="display: none;"></div>
        <form id="samlConfigForm" class="sso-form" data-provider-type="SAML" data-provider-id="saml_miniorange">
            <input type="hidden" id="samlConfigId">
            <h4>General Settings</h4>
            <div class="toggle-switch">
                <label for="samlEnable">Enable SAML Provider:</label>
                <label class="switch"><input type="checkbox" id="samlEnable"><span class="slider"></span></label>
            </div>
            <label for="samlDisplayName">Display Name:</label>
            <input type="text" id="samlDisplayName" placeholder="e.g., Okta SAML">
            <h4>Identity Provider (IdP) Details</h4>
            <label for="samlEntityId">Identity Provider Entity ID:</label>
            <input type="text" id="samlEntityId" placeholder="e.g., https://idp.example.com/entityid">
            <label for="samlSsoUrl">SSO URL (Login Endpoint):</label>
            <input type="url" id="samlSsoUrl" placeholder="e.g., https://idp.example.com/sso">
            <label for="samlCertificate">X.509 Certificate (PEM format):</label>
            <textarea id="samlCertificate" placeholder="Paste the certificate here..."></textarea>
            <button type="submit" class="btn-save">Save SAML Config</button>
            <button type="button" class="btn-test" onclick="testAttributes('saml_miniorange')">
                Test Connection
            </button>
            <button type="button" class="btn-test" style="background-color: #6c757d;" onclick="showDebugInfo()">
                Debug Info
            </button>
        </form>

        <h4>Your Service Provider (SP) URLs</h4>
        <p class="form-hint">Provide these URLs to your Identity Provider (IdP) to complete the setup.</p>
        <div class="url-display-box">
            <label>SP Entity ID (Issuer / Audience URI):</label>
            <code>https://<span class="dynamic-subdomain">your-subdomain</span>.prajwal.cfd/saml2/service-provider-metadata/saml_miniorange</code>
            <label>ACS URL (Reply URL):</label>
            <code>https://<span class="dynamic-subdomain">your-subdomain</span>.prajwal.cfd/login/saml2/sso/saml_miniorange</code>
        </div>
    </div>

    <div id="oidcConfig" class="tab-content">
        <h2>OAuth 2.0 / OpenID Connect Configuration</h2>
        <div id="oidc-error-message" class="error" style="display: none;"></div>
        <form id="oidcConfigForm" class="sso-form" data-provider-type="OIDC" data-provider-id="oidc_miniorange">
            <input type="hidden" id="oidcConfigId">
            <h4>General Settings</h4>
            <div class="toggle-switch">
                <label for="oidcEnable">Enable OIDC Provider:</label>
                <label class="switch"><input type="checkbox" id="oidcEnable"><span class="slider"></span></label>
            </div>
            <label for="oidcDisplayName">Display Name:</label>
            <input type="text" id="oidcDisplayName" placeholder="e.g., MiniOrange OIDC">
            <h4>Identity Provider (IdP) Details</h4>
            <label for="oidcIssuerUri">Issuer URI: (Leave blank to use discovery)</label>
            <input type="url" id="oidcIssuerUri" placeholder="e.g., httpss://csumairkhan.xecurify.com/moas/discovery/v2.0/...">
            <div class="form-row">
                <div><label for="oidcClientId">Client ID:</label><input type="text" id="oidcClientId"></div>
                <div>
                    <label for="oidcClientSecret">Client Secret:</label>
                    <div class="password-wrapper">
                        <input type="password" id="oidcClientSecret" placeholder="Enter new secret to update">
                        <button type="button" class="toggle-password" id="toggleOidcSecret">Show</button>
                    </div>
                </div>
            </div>
            <label for="oidcScopes">Scopes (comma-separated):</label>
            <input type="text" id="oidcScopes" value="openid, profile, email">
            <label for="oidcUserNameAttribute">User Name Attribute (claim):</label>
            <input type="text" id="oidcUserNameAttribute" value="email" placeholder="e.g., email or sub">
            <h4>Endpoint Overrides (Optional)</h4>
            <label for="oidcAuthorizationUri">Authorization Endpoint URI:</label>
            <input type="url" id="oidcAuthorizationUri">
            <label for="oidcTokenUri">Token Endpoint URI:</label>
            <input type="url" id="oidcTokenUri">
            <label for="oidcUserInfoUri">UserInfo Endpoint URI:</label>
            <input type="url" id="oidcUserInfoUri">
            <label for="oidcJwkSetUri">JWK Set URI:</label>
            <input type="url" id="oidcJwkSetUri">
            <button type="submit" class="btn-save">Save OIDC Config</button>
            <button type="button" class="btn-test" onclick="testAttributes('oidc_miniorange')">
                Test Connection
            </button>
            <button type="button" class="btn-test" style="background-color: #6c757d;" onclick="showDebugInfo()">
                Debug Info
            </button>
        </form>

        <h4>Your OIDC Redirect URI</h4>
        <p class="form-hint">Provide this URL to your Identity Provider (IdP) as the Redirect or Callback URL.</p>
        <div class="url-display-box">
            <label>Redirect URI:</label>
            <code>https://<span class="dynamic-subdomain">your-subdomain</span>.prajwal.cfd/login/oauth2/code/oidc_miniorange</code>
        </div>
    </div>

    <div id="jwtConfig" class="tab-content">
        <h2>Manual JWT Configuration</h2>
        <div id="jwt-error-message" class="error" style="display: none;"></div>
        <form id="jwtConfigForm" class="sso-form" data-provider-type="JWT" data-provider-id="jwt_miniorange">
            <input type="hidden" id="jwtConfigId">
            <h4>General Settings</h4>
            <div class="toggle-switch">
                <label for="jwtEnable">Enable JWT Provider:</label>
                <label class="switch"><input type="checkbox" id="jwtEnable"><span class="slider"></span></label>
            </div>
            <label for="jwtDisplayName">Display Name:</label>
            <input type="text" id="jwtDisplayName" placeholder="e.g., MiniOrange JWT">
            <h4>Identity Provider (IdP) Details</h4>
            <label for="jwtSsoUrl">JWT SSO URL:</label>
            <input type="url" id="jwtSsoUrl" placeholder="e.g., https://idp.example.com/jwtsso/appid">
            <div class="form-row">
                <div><label for="jwtClientId">Client ID:</label><input type="text" id="jwtClientId"></div>
                <div>
                    <label for="jwtClientSecret">Client Secret (if applicable):</label>
                    <div class="password-wrapper">
                        <input type="password" id="jwtClientSecret" placeholder="Secret if needed by IdP">
                        <button type="button" class="toggle-password" id="toggleJwtSecret">Show</button>
                    </div>
                </div>
            </div>
            <label for="jwtRedirectUri">Redirect URI (Callback URL):</label>
            <input type="url" id="jwtRedirectUri" placeholder="e.g., https://your-subdomain.prajwal.cfd/login/jwt/callback">
            <label for="jwtIssuerUri">Expected Issuer (iss claim):</label>
            <input type="text" id="jwtIssuerUri" placeholder="e.g., Your Client ID or Issuer URL">
            <label for="jwtCertificate">Certificate Content (PEM format):</label>
            <textarea id="jwtCertificate" placeholder="Paste PEM certificate here..."></textarea>
            <button type="submit" class="btn-save">Save JWT Config</button>
            <button type="button" class="btn-test" onclick="testAttributes('jwt_miniorange')">
                Test Connection
            </button>
            <button type="button" class="btn-test" style="background-color: #6c757d;" onclick="showDebugInfo()">
                Debug Info
            </button>
        </form>

        <h4>Your JWT Callback URL</h4>
        <p class="form-hint">Provide this URL to your IdP and enter the <strong>exact same value</strong> in the "Redirect URI" field above.</p>
        <div class="url-display-box">
            <label>Callback URL:</label>
            <code>https://<span class="dynamic-subdomain">your-subdomain</span>.prajwal.cfd/login/jwt/callback</code>
        </div>
    </div>

    <div id="kerberosConfig" class="tab-content">
        <h2>Kerberos / SPNEGO Configuration</h2>
        <p>Configure Windows Active Directory integrated authentication using Kerberos/SPNEGO protocol.</p>
        <div id="kerberos-error-message" class="error" style="display: none;"></div>

        <form id="kerberosConfigForm" class="sso-form" data-provider-type="KERBEROS" data-provider-id="kerberos_ad">
            <input type="hidden" id="kerberosConfigId">

            <h4>General Settings</h4>
            <div class="toggle-switch">
                <label for="kerberosEnable">Enable Kerberos Provider:</label>
                <label class="switch"><input type="checkbox" id="kerberosEnable"><span class="slider"></span></label>
            </div>
            <label for="kerberosDisplayName">Display Name:</label>
            <input type="text" id="kerberosDisplayName" placeholder="e.g., Windows Login">

            <h4>Active Directory Configuration</h4>
            <label for="kerberosServicePrincipal">Service Principal Name (SPN):</label>
            <input type="text" id="kerberosServicePrincipal" placeholder="HTTP/yourapp.yourdomain.com@YOURDOMAIN.COM" required>
            <p class="form-hint">
                Register this SPN in AD using: <code>setspn -A HTTP/yourapp.yourdomain.com serviceAccount</code>
            </p>

            <label for="kerberosRealm">Kerberos Realm (Domain):</label>
            <input type="text" id="kerberosRealm" placeholder="YOURDOMAIN.COM" required>
            <p class="form-hint">Must match your Active Directory domain (uppercase).</p>

            <label for="kerberosKdcServer">KDC Server (Domain Controller):</label>
            <input type="text" id="kerberosKdcServer" placeholder="dc.yourdomain.com" required>
            <p class="form-hint">Hostname or IP of your Active Directory Domain Controller.</p>

            <label for="kerberosKeytabFile">Keytab File:</label>
            <input type="file" id="kerberosKeytabFile" accept=".keytab">
            <p class="form-hint">
                Generate keytab using: <code>ktpass -out app.keytab -princ HTTP/yourapp.yourdomain.com@YOURDOMAIN.COM -mapUser serviceAccount -pass * -ptype KRB5_NT_PRINCIPAL</code>
            </p>
            <div id="keytab-status" style="margin-top: 10px; color: #666; font-size: 0.9em;"></div>

            <h4>User Mapping</h4>
            <label for="kerberosUserNameAttribute">Username Extraction Method:</label>
            <select id="kerberosUserNameAttribute">
                <option value="username">Username only (user@DOMAIN → user)</option>
                <option value="email">Full principal as email (user@DOMAIN)</option>
                <option value="upn">User Principal Name (UPN)</option>
            </select>
            <p class="form-hint">How to extract the username from the Kerberos principal.</p>

            <button type="submit" class="btn-save">Save Kerberos Config</button>
            <button type="button" class="btn-test" onclick="testKerberosConnection()">
                Test Connection
            </button>
            <button type="button" class="btn-test" style="background-color: #6c757d;" onclick="showDebugInfo()">
                Debug Info
            </button>
        </form>

        <h4>Integration Instructions</h4>
        <div class="url-display-box">
            <label>Step 1: Register SPN in Active Directory</label>
            <code>setspn -A HTTP/<span class="dynamic-subdomain">your-subdomain</span>.prajwal.cfd serviceAccount</code>

            <label>Step 2: Generate Keytab</label>
            <code>ktpass -out app.keytab -princ HTTP/<span class="dynamic-subdomain">your-subdomain</span>.prajwal.cfd@YOURDOMAIN.COM -mapUser serviceAccount -pass * -ptype KRB5_NT_PRINCIPAL</code>

            <label>Step 3: Configure Browser (Chrome/Edge)</label>
            <code>Add https://<span class="dynamic-subdomain">your-subdomain</span>.prajwal.cfd to: chrome://policy → AuthServerWhitelist</code>

            <label>Step 4: Test Access</label>
            <p style="margin-top: 10px;">Users should automatically authenticate when accessing your subdomain from a domain-joined Windows machine.</p>
        </div>
    </div>



</div>

<div id="userModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2 id="modalTitle">User Form</h2>
        <div id="modal-error" class="error" style="display: none;"></div>
        <form id="userForm">
            <input type="hidden" id="userId">
            <div><label for="username">Username:</label><input type="text" id="username" required></div>
            <div><label for="email">Email:</label><input type="email" id="email" required></div>

            <div>
                <label for="password">Password:</label>
                <div class="password-wrapper">
                    <input type="password" id="password" placeholder="Leave blank if no change">
                    <button type="button" class="toggle-password" id="toggleUserPassword">Show</button>
                </div>
            </div>
            <div><label for="firstName">First Name:</label><input type="text" id="firstName"></div>
            <div><label for="lastName">Last Name:</label><input type="text" id="lastName"></div>
            <div><label for="roles">Roles:</label><input type="text" id="roles" placeholder="e.g., ROLE_USER,ROLE_ADMIN"></div>
            <button type="submit" class="btn-save">Save User</button>
        </form>
    </div>
</div>


<script>
    // --- Global/Admin Variables ---
    const userTableBody = document.getElementById('user-table').getElementsByTagName('tbody')[0];
    const errorMessageDiv = document.getElementById('error-message');
    const token = localStorage.getItem('accessToken');
    const modal = document.getElementById('userModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalError = document.getElementById('modal-error');
    const userForm = document.getElementById('userForm');
    const userIdInput = document.getElementById('userId');

    // --- SSO Form Variables ---
    const samlErrorDiv = document.getElementById('saml-error-message');
    const oidcErrorDiv = document.getElementById('oidc-error-message');
    const jwtErrorDiv = document.getElementById('jwt-error-message');
    const kerberosErrorDiv = document.getElementById('kerberos-error-message');
    const samlConfigForm = document.getElementById('samlConfigForm');
    const oidcConfigForm = document.getElementById('oidcConfigForm');
    const jwtConfigForm = document.getElementById('jwtConfigForm');
    const kerberosConfigForm = document.getElementById('kerberosConfigForm');
    let configDataStore = {}; // Stores config state { 'providerId': { id: 1, ... } }

    // --- Branding Variables ---
    const brandingForm = document.getElementById('brandingConfigForm');
    const brandingErrorDiv = document.getElementById('branding-error-message');
    const brandingSuccessDiv = document.getElementById('branding-success-message');
    const brandingSubdomainInput = document.getElementById('brandingSubdomain');
    const brandingLogoUrlInput = document.getElementById('brandingLogoUrl');
    const brandingPrimaryColorInput = document.getElementById('brandingPrimaryColor');
    const subdomainPreview = document.getElementById('subdomain-preview');


    // --- Apply Branding on Load ---
    (async function initializeTenantAdmin() {
        if (!token) {
             window.location.href = '/login';
             return;
        }
        try {
            const response = await fetch('/api/public/branding', {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            if (!response.ok) throw new Error("Could not fetch branding");

            const branding = await response.json();
            if (branding.brandingLogoUrl) {
                const logoEl = document.getElementById('header-logo');
                logoEl.src = branding.brandingLogoUrl;
                logoEl.style.display = 'inline-block';
                document.getElementById('header-logo-text').style.display = 'none';
            }
            if (branding.tenantName) {
                document.getElementById('header-logo-text').textContent = `${branding.tenantName} Admin`;
            }
            if (branding.brandingPrimaryColor) {
                document.documentElement.style.setProperty('--primary-orange', branding.brandingPrimaryColor);
            }
        } catch (error) {
            console.error('Error fetching branding:', error);
        }
    })();

    // --- Tab switching logic (Modified) ---
    function openTab(evt, tabName) {
        clearSsoErrors('all');
        clearBrandingMessages();
        clearUserModalError();

        const tabcontent = document.getElementsByClassName("tab-content");
        for (let i = 0; i < tabcontent.length; i++) tabcontent[i].style.display = "none";
        const tablinks = document.getElementsByClassName("tab-button");
        for (let i = 0; i < tablinks.length; i++) tablinks[i].className = tablinks[i].className.replace(" active", "");

        const currentTab = document.getElementById(tabName);
        if (currentTab) currentTab.style.display = "block";
        if (evt && evt.currentTarget) evt.currentTarget.className += " active";

        if (tabName === 'userManagement') loadUsers();
        else if (tabName === 'brandingConfig') loadBrandingSettings();
        else if (tabName === 'samlConfig' || tabName === 'oidcConfig' || tabName === 'jwtConfig' || tabName === 'kerberosConfig') {
            loadSsoConfigurations();
            updateDynamicSubdomainUrls(brandingSubdomainInput.value || 'your-subdomain'); // Pass current value
        }
    }

    // --- Branding Functions ---

    // Updates all dynamic subdomain spans across all tabs
    function updateDynamicSubdomainUrls(subdomain) {
        const cleanSubdomain = subdomain.toLowerCase().trim().replaceAll(' ', '-') || 'your-subdomain';

        if (subdomainPreview) {
            subdomainPreview.textContent = cleanSubdomain;
        }

        const allSpans = document.querySelectorAll('.dynamic-subdomain');
        allSpans.forEach(span => {
            span.textContent = cleanSubdomain;
        });
    }

    async function loadBrandingSettings() {
        clearBrandingMessages();
        try {
            const response = await fetch('/api/admin/branding', { headers: { 'Authorization': 'Bearer ' + token } });
            if (!response.ok) return handleApiError(response, "load branding settings", false, brandingErrorDiv);

            const branding = await response.json();
            brandingSubdomainInput.value = branding.subdomain || '';
            brandingLogoUrlInput.value = branding.brandingLogoUrl || '';
            brandingPrimaryColorInput.value = branding.brandingPrimaryColor || '';

            updateDynamicSubdomainUrls(branding.subdomain);

        } catch (error) {
            console.error('Load branding error:', error);
            showBrandingError(`Failed to load branding: ${error.message}`);
        }
    }

    brandingSubdomainInput.addEventListener('input', (e) => {
        updateDynamicSubdomainUrls(e.target.value);
    });

    brandingForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        clearBrandingMessages();
        const brandingData = {
            subdomain: brandingSubdomainInput.value,
            brandingLogoUrl: brandingLogoUrlInput.value,
            brandingPrimaryColor: brandingPrimaryColorInput.value
        };

        try {
            const response = await fetch('/api/admin/branding', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                body: JSON.stringify(brandingData)
            });

            if (!response.ok) return handleApiError(response, "update branding", false, brandingErrorDiv);

            const updatedBranding = await response.json();
            showBrandingSuccess(`Branding updated successfully! Your login URL is active at: https://${updatedBranding.subdomain}.prajwal.cfd/login`);

            document.documentElement.style.setProperty('--primary-orange', updatedBranding.brandingPrimaryColor || '#FF6600');
            if (updatedBranding.brandingLogoUrl) {
                 document.getElementById('header-logo').src = updatedBranding.brandingLogoUrl;
                 document.getElementById('header-logo').style.display = 'inline-block';
                 document.getElementById('header-logo-text').style.display = 'none';
            }
        } catch (error) {
            console.error('Save branding error:', error);
            showBrandingError(`Save failed: ${error.message}`);
        }
    });

    function showBrandingError(message) { brandingErrorDiv.textContent = message; brandingErrorDiv.style.display = 'block'; }
    function showBrandingSuccess(message) { brandingSuccessDiv.textContent = message; brandingSuccessDiv.style.display = 'block'; }
    function clearBrandingMessages() {
        brandingErrorDiv.style.display = 'none'; brandingErrorDiv.textContent = '';
        brandingSuccessDiv.style.display = 'none'; brandingSuccessDiv.textContent = '';
    }

    // --- (START) USER MANAGEMENT FUNCTIONS ---

    async function loadUsers() {
        clearUserModalError();
        userTableBody.innerHTML = '<tr><td colspan="8">Loading users...</td></tr>';
        try {
            const response = await fetch('/api/admin/users', {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            if (!response.ok) {
                return handleApiError(response, "load users", false, errorMessageDiv);
            }
            const users = await response.json();
            renderUserTable(users);
        } catch (error) {
            console.error('Load users error:', error);
            showUserError(`Failed to load users: ${error.message}`);
        }
    }

    function renderUserTable(users) {
        userTableBody.innerHTML = '';
        if (!users || users.length === 0) {
            userTableBody.innerHTML = '<tr><td colspan="8">No users found.</td></tr>';
            return;
        }
        users.forEach(user => {
            const row = userTableBody.insertRow();
            row.insertCell().textContent = user.id;
            row.insertCell().textContent = user.username;
            row.insertCell().textContent = user.email;
            row.insertCell().textContent = user.firstName || '';
            row.insertCell().textContent = user.lastName || '';
            row.insertCell().textContent = user.roles || 'ROLE_USER';
            row.insertCell().textContent = user.authProvider;
            row.insertCell().innerHTML = `
                <button onclick="openEditModal(${user.id})" class="btn-edit">Edit</button>
                <button onclick="deleteUser(${user.id})" class="btn-delete">Delete</button>
            `;
        });
    }

    function openCreateModal() {
        clearUserModalError();
        userForm.reset();
        userIdInput.value = '';
        modalTitle.textContent = 'Create New User';
        document.getElementById('password').placeholder = "Password (required)";
        document.getElementById('password').setAttribute('type', 'password');
        document.getElementById('toggleUserPassword').textContent = 'Show';
        modal.style.display = "block";
    }

    async function openEditModal(id) {
        clearUserModalError();
        userForm.reset();
        try {
            const response = await fetch(`/api/admin/users/${id}`, {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            if (!response.ok) { return handleApiError(response, `fetch user ${id}`, false, errorMessageDiv); }
            const user = await response.json();

            userIdInput.value = user.id;
            document.getElementById('username').value = user.username;
            document.getElementById('email').value = user.email;
            document.getElementById('firstName').value = user.firstName || '';
            document.getElementById('lastName').value = user.lastName || '';
            document.getElementById('roles').value = user.roles || '';
            document.getElementById('password').placeholder = "Leave blank if no change";
            document.getElementById('password').setAttribute('type', 'password');
            document.getElementById('toggleUserPassword').textContent = 'Show';

            modalTitle.textContent = 'Edit User: ' + user.username;
            modal.style.display = "block";
        } catch(error) {
            console.error("Edit user error:", error);
            showUserError(`Failed to load user: ${error.message}`);
        }
    }

    async function deleteUser(id) {
        if (!confirm('Are you sure you want to delete this user? This cannot be undone.')) {
            return;
        }
        clearUserModalError();
        try {
            const response = await fetch(`/api/admin/users/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': 'Bearer ' + token }
            });
            if (!response.ok) { return handleApiError(response, `delete user ${id}`, false, errorMessageDiv); }

            loadUsers();
        } catch (error) {
            console.error("Delete user error:", error);
            showUserError(`Failed to delete user: ${error.message}`);
        }
    }

    function closeModal() {
        modal.style.display = "none";
    }
    window.onclick = function(event) {
        if (event.target == modal) {
            closeModal();
        }
    }

    userForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        clearUserModalError();

        const id = userIdInput.value;
        const isUpdate = !!id;

        const data = {
            username: document.getElementById('username').value,
            email: document.getElementById('email').value,
            password: document.getElementById('password').value,
            firstName: document.getElementById('firstName').value,
            lastName: document.getElementById('lastName').value,
            roles: document.getElementById('roles').value
        };

        if (isUpdate && !data.password) {
            delete data.password; // Don't send empty password on update
        }

        const url = isUpdate ? `/api/admin/users/${id}` : '/api/admin/users';
        const method = isUpdate ? 'PUT' : 'POST';
        const action = isUpdate ? 'update user' : 'create user';

        try {
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                body: JSON.stringify(data)
            });
            if (!response.ok) { return handleApiError(response, action, true, modalError); }

            closeModal();
            loadUsers();
        } catch (error) {
            console.error(`${action} error:`, error);
            showUserModalError(`Save failed: ${error.message}`);
        }
    });

    // --- (END) USER MANAGEMENT FUNCTIONS ---


    // --- (START) SSO CONFIG FUNCTIONS ---

    // Helper function to read a file as a Base64 string
    function readFileAsBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => {
                // result contains "data:application/octet-stream;base64,BASE64_STRING"
                // We just want the part after the comma
                const base64String = reader.result.split(',')[1];
                resolve(base64String);
            };
            reader.onerror = (error) => reject(error);
            reader.readAsDataURL(file);
        });
    }

    async function loadSsoConfigurations() {
        const maxRetries = 3;
        let attempt = 0;

        while (attempt < maxRetries) {
            try {
                console.log(`[SSO Config] Loading attempt ${attempt + 1}/${maxRetries}...`);

                const response = await fetch('/api/admin/sso-config', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`[SSO Config] Load failed (${response.status}):`, errorText);

                    if (response.status === 401 || response.status === 403) {
                        showSsoError('Session expired or access denied. Please refresh the page.', 'all');
                        return;
                    }
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const configs = await response.json();
                console.log(`[SSO Config] Loaded ${configs.length} configs:`, configs);

                configDataStore = {}; // Clear old data

                configs.forEach(config => {
                    console.log(`[SSO Config] Processing config:`, {
                        id: config.id,
                        providerId: config.providerId,
                        type: config.providerType,
                        enabled: config.enabled
                    });
                    configDataStore[config.providerId] = config;
                    populateSsoForm(config);
                });

                console.log('[SSO Config] Load completed successfully');
                return; // Success - exit retry loop

            } catch (error) {
                attempt++;
                console.error(`[SSO Config] Load attempt ${attempt} failed:`, error);
                if (attempt >= maxRetries) {
                    showSsoError(`Failed to load SSO configurations after ${maxRetries} attempts: ${error.message}`, 'all');
                    return;
                }
                await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
            }
        }
    }

    function populateSsoForm(config) {
        const prefix = config.providerType.toLowerCase();
        console.log(`[populateSsoForm] Processing ${prefix}:`, config);

        const configIdEl = document.getElementById(`${prefix}ConfigId`);
        const enableEl = document.getElementById(`${prefix}Enable`);
        const displayNameEl = document.getElementById(`${prefix}DisplayName`);

        if (!configIdEl || !enableEl || !displayNameEl) {
            console.error(`[populateSsoForm] Missing form elements for ${prefix}`);
            return;
        }

        configIdEl.value = config.id || '';
        enableEl.checked = config.enabled;
        displayNameEl.value = config.displayName || '';

        // Common fields
        const clientIdEl = document.getElementById(`${prefix}ClientId`);
        const issuerUriEl = document.getElementById(`${prefix}IssuerUri`);
        if (clientIdEl) clientIdEl.value = config.clientId || '';
        if (issuerUriEl) issuerUriEl.value = config.issuerUri || '';

        // Type-specific fields
        if (prefix === 'oidc') {
            document.getElementById('oidcScopes').value = config.scopes || 'openid, profile, email';
            document.getElementById('oidcUserNameAttribute').value = config.userNameAttribute || 'email';
            document.getElementById('oidcAuthorizationUri').value = config.authorizationUri || '';
            document.getElementById('oidcTokenUri').value = config.tokenUri || '';
            document.getElementById('oidcUserInfoUri').value = config.userInfoUri || '';
            document.getElementById('oidcJwkSetUri').value = config.jwkSetUri || '';
            document.getElementById('oidcClientSecret').value = ''; // Always clear secret field
        } else if (prefix === 'saml') {
            document.getElementById('samlEntityId').value = config.samlEntityId || '';
            document.getElementById('samlSsoUrl').value = config.samlSsoUrl || '';
            document.getElementById('samlCertificate').value = config.samlCertificate || '';
        } else if (prefix === 'jwt') {
            document.getElementById('jwtSsoUrl').value = config.jwtSsoUrl || '';
            document.getElementById('jwtRedirectUri').value = config.jwtRedirectUri || '';
            document.getElementById('jwtCertificate').value = config.jwtCertificate || '';
            document.getElementById('jwtClientSecret').value = ''; // Always clear secret field
        } else if (prefix === 'kerberos') {
            document.getElementById('kerberosServicePrincipal').value = config.kerberosServicePrincipal || '';
            document.getElementById('kerberosRealm').value = config.kerberosRealm || '';
            document.getElementById('kerberosKdcServer').value = config.kerberosKdcServer || '';
            document.getElementById('kerberosUserNameAttribute').value = config.kerberosUserNameAttribute || 'username';

            // Show keytab status
            const keytabStatus = document.getElementById('keytab-status');
            if (config.kerberosKeytabBase64 && config.kerberosKeytabBase64.length > 0) {
                keytabStatus.textContent = '✓ Keytab file is currently on server';
                keytabStatus.style.color = 'var(--success-color)';
            } else {
                keytabStatus.textContent = '⚠ No keytab file uploaded';
                keytabStatus.style.color = 'var(--error-color)';
            }
            // Clear the file input
            document.getElementById('kerberosKeytabFile').value = '';
        }
    }

    // --- **FIXED EVENT LISTENER BLOCK** ---
    // This block replaces the two old, conflicting blocks.
    // 1. Corrected 'samlConfigFom' typo.
    // 2. Added 'kerberosConfigForm' to the array.
    // 3. Added logic to handle the 'kerberosKeytabFile' upload.
    [samlConfigForm, oidcConfigForm, jwtConfigForm, kerberosConfigForm].forEach(form => {
        // We must use a new, clean listener attachment
        const actualForm = document.getElementById(form.id);

        actualForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const providerType = actualForm.dataset.providerType;
            const providerId = actualForm.dataset.providerId;
            const prefix = providerType.toLowerCase();

            console.log(`[${providerType}] Form submission started:`, { providerType, providerId });
            clearSsoErrors(providerType);

            const storedConfig = configDataStore[providerId];
            const configId = storedConfig?.id;

            // Build data payload
            const data = {
                providerId: providerId,
                providerType: providerType,
                enabled: document.getElementById(`${prefix}Enable`).checked,
                displayName: document.getElementById(`${prefix}DisplayName`).value,

                // Common fields
                clientId: document.getElementById(`${prefix}ClientId`)?.value || null,
                clientSecret: document.getElementById(`${prefix}ClientSecret`)?.value || null,
                issuerUri: document.getElementById(`${prefix}IssuerUri`)?.value || null,

                // OIDC fields
                scopes: document.getElementById('oidcScopes')?.value || null,
                userNameAttribute: document.getElementById('oidcUserNameAttribute')?.value || null,
                authorizationUri: document.getElementById('oidcAuthorizationUri')?.value || null,
                tokenUri: document.getElementById('oidcTokenUri')?.value || null,
                userInfoUri: document.getElementById('oidcUserInfoUri')?.value || null,
                jwkSetUri: document.getElementById('oidcJwkSetUri')?.value || null,

                // SAML fields
                samlEntityId: document.getElementById('samlEntityId')?.value || null,
                samlSsoUrl: document.getElementById('samlSsoUrl')?.value || null,
                samlCertificate: document.getElementById('samlCertificate')?.value || null,

                // JWT fields
                jwtSsoUrl: document.getElementById('jwtSsoUrl')?.value || null,
                jwtRedirectUri: document.getElementById('jwtRedirectUri')?.value || null,
                jwtCertificate: document.getElementById('jwtCertificate')?.value || null,

                // Kerberos fields
                kerberosServicePrincipal: document.getElementById('kerberosServicePrincipal')?.value || null,
                kerberosRealm: document.getElementById('kerberosRealm')?.value || null,
                kerberosKdcServer: document.getElementById('kerberosKdcServer')?.value || null,
                kerberosUserNameAttribute: document.getElementById('kerberosUserNameAttribute')?.value || null,
                kerberosKeytabBase64: null // Start as null, will be populated if file is added
            };

            // Don't send empty secret on update
            if (configId && !data.clientSecret) {
                delete data.clientSecret;
            }

            // Determine endpoint and method
            const url = configId ? `/api/admin/sso-config/${configId}` : '/api/admin/sso-config';
            const method = configId ? 'PUT' : 'POST';
            const action = configId ? 'update' : 'create';

            // Handle Kerberos keytab file upload
            if (providerType === 'KERBEROS') {
                const keytabFileInput = document.getElementById('kerberosKeytabFile');
                const keytabFile = keytabFileInput.files[0];

                if (keytabFile) {
                    try {
                        console.log(`[KERBEROS] Reading keytab file...`);
                        data.kerberosKeytabBase64 = await readFileAsBase64(keytabFile);
                        console.log(`[KERBEROS] Keytab file read successfully.`);
                    } catch (e) {
                        console.error("[KERBEROS] Error reading keytab file:", e);
                        showSsoError(`Failed to read keytab file: ${e.message}`, providerType);
                        return; // Stop submission
                    }
                }
                // If no file is selected, kerberosKeytabBase64 remains null.
                // The backend SsoProviderConfigUpdateRequest DTO must handle this
                // (i.e., not update the keytab if the field is null on an existing config).
            }

            console.log(`[${providerType}] Sending ${method} request to ${url}`);

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    let errorMessage = `Failed to ${action} ${providerType} config (${response.status})`;
                    try {
                        const errorData = JSON.parse(errorText);
                        if (errorData.message) errorMessage = errorData.message;
                    } catch (e) { errorMessage += `: ${errorText}`; }

                    console.error(`[${providerType}] ${action.toUpperCase()} FAILED:`, errorMessage);
                    showSsoError(errorMessage, providerType);
                    return;
                }

                const updatedConfig = await response.json();
                console.log(`[${providerType}] ${action.toUpperCase()} SUCCESS:`, updatedConfig);

                // Update stored config
                configDataStore[updatedConfig.providerId] = updatedConfig;
                populateSsoForm(updatedConfig); // Re-populate form with saved data

                alert(`✓ ${providerType} configuration ${action}d successfully!`);

            } catch (error) {
                console.error(`[${providerType}] ${action.toUpperCase()} ERROR:`, error);
                showSsoError(`Failed to ${action}: ${error.message}`, providerType);
            }
        });
    });
    // --- **END FIXED LISTENER BLOCK** ---


    function testAttributes(providerId) {
        const config = configDataStore[providerId];
        if (!config || !config.enabled) {
            alert("Please save and enable the configuration before testing.");
            return;
        }
        window.open(`/api/sso/test-attributes/${providerId}`, 'ssoTestWindow', 'width=600,height=700');
    }

    function testKerberosConnection() {
        const config = configDataStore['kerberos_ad'];
        if (!config || !config.enabled) {
            alert("Please save and enable the Kerberos configuration before testing.");
            return;
        }
        alert("Kerberos testing is performed by logging in from a domain-joined machine. Navigate to your login page from a client machine that is part of the Active Directory domain to test the connection.");
    }

    async function showDebugInfo() {
        try {
            const response = await fetch('/api/admin/sso-config/debug/tenant-info', {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            if (!response.ok) { alert('Debug endpoint failed: ' + response.status); return; }
            const debug = await response.json();
            let message = `=== TENANT DEBUG INFO ===\n\n`;
            message += `Current Tenant ID: ${debug.currentTenantId}\n`;
            message += `Timestamp: ${new Date(debug.timestamp).toLocaleString()}\n\n`;
            message += `=== MY VISIBLE CONFIGS ===\n`;
            debug.myVisibleConfigs.forEach(c => {
                message += `- ID: ${c.id}, Provider: ${c.providerId}\n`;
            });
            message += `\n=== ALL CONFIGS IN DATABASE ===\n`;
            debug.allConfigsInDatabase.forEach(c => {
                message += `- ID: ${c.id}, Provider: ${c.providerId}, Type: ${c.providerType}\n`;
                message += `  Tenant: ${c.tenantId} (${c.subdomain}), Visible: ${c.visibleToMe}\n`;
            });
            console.log(message);
A;
        } catch (error) {
            console.error('Debug info failed:', error);
            alert('Failed to fetch debug info: ' + error.message);
        }
    }

    // --- (END) SSO CONFIG FUNCTIONS ---


    // --- Utility/Error Functions ---
    function getErrorDivForType(providerType) {
        if (providerType === 'SAML') return samlErrorDiv;
        if (providerType === 'OIDC') return oidcErrorDiv;
        if (providerType === 'JWT') return jwtErrorDiv;
        if (providerType === 'KERBEROS') return kerberosErrorDiv;
        if (providerType === 'BRANDING') return brandingErrorDiv;
        return errorMessageDiv; // Default for 'all' or user management
    }
     function showSsoError(message, providerType = 'all') {
         const div = getErrorDivForType(providerType);
         if (div) { div.textContent = message; div.style.display = 'block'; }
     }
     function clearSsoErrors(providerType = 'all') {
         if (providerType === 'all' || providerType === 'SAML') { samlErrorDiv.textContent = ''; samlErrorDiv.style.display = 'none'; }
         if (providerType === 'all' || providerType === 'OIDC') { oidcErrorDiv.textContent = ''; oidcErrorDiv.style.display = 'none'; }
         if (providerType === 'all' || providerType === 'JWT') { jwtErrorDiv.textContent = ''; jwtErrorDiv.style.display = 'none'; }
         if (providerType === 'all' || providerType === 'KERBEROS') { kerberosErrorDiv.textContent = ''; kerberosErrorDiv.style.display = 'none'; }
     }
     function showUserError(message) { errorMessageDiv.textContent = message; errorMessageDiv.style.display = 'block'; }
     function showUserModalError(message) { modalError.textContent = message; modalError.style.display = 'block'; }
     function clearUserModalError() {
         errorMessageDiv.textContent = ''; errorMessageDiv.style.display = 'none';
         modalError.textContent = ''; modalError.style.display = 'none';
     }

     async function handleApiError(response, actionDescription, showInModal = false, targetErrorDiv = null) {
         let errorDisplayDiv = showInModal ? modalError : (targetErrorDiv || errorMessageDiv);
         let errorMessage = `Failed to ${actionDescription} (Status: ${response.status})`;
         try {
             const errorData = await response.json();
             if (response.status === 409) {
                 errorMessage = errorData.message || "Conflict: Resource already exists.";
             } else if (errorData.message) {
                 errorMessage = errorData.message;
             } else if (errorData.errors) {
                 errorMessage = "Validation Failed: " + Object.values(errorData.errors).join('; ');
             }
         } catch (e) { /* Ignore */ }

         console.error(`API Error during ${actionDescription}:`, errorMessage);
         if (response.status === 403) errorMessage = "Permission Denied. You must be a Customer Admin.";
         else if (response.status === 401) errorMessage = "Session Expired. Please log in.";

         if (errorDisplayDiv) { errorDisplayDiv.textContent = errorMessage; errorDisplayDiv.style.display = 'block'; }
         else { console.error("Target error div not found for message:", errorMessage); }
     }

    // --- Password Toggle & Logout ---
    function setupPasswordToggle(inputId, toggleId) {
        const passwordInput = document.getElementById(inputId);
        const toggleButton = document.getElementById(toggleId);
        if (passwordInput && toggleButton) {
            toggleButton.addEventListener('click', (e) => {
                e.preventDefault();
                const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput.setAttribute('type', type);
                toggleButton.textContent = type === 'password' ? 'Show' : 'Hide';
            });
        }
    }
    setupPasswordToggle('oidcClientSecret', 'toggleOidcSecret');
    setupPasswordToggle('jwtClientSecret', 'toggleJwtSecret');
    setupPasswordToggle('password', 'toggleUserPassword');

    const logoutButton = document.getElementById('logout-button');
    if (logoutButton) {
        logoutButton.addEventListener('click', () => {
            localStorage.removeItem('accessToken');
            localStorage.removeItem('userInfo');
            window.location.href = '/login';
        });
    }

    // --- Initial Page Load Check ---
    if (token) {
        document.getElementById("welcome").style.display = "block";
    } else {
         setTimeout(() => { window.location.href = '/login'; }, 1000);
    }
</script>

</body>
</html>